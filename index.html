<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>HAI Assistant</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="manifest" href="#" id="pwa-manifest-link" />
<style>
  :root {
    --brand: #ED1849;
    --brand-eggplant: #830065;
    --brand-warn: #F99B1C;
    --brand-apricot: #F15F22;
    --brand-lemon: #FFD600;
    --brand-plum: #B32572;
    --ok: #1c7c3e;
    --warn: var(--brand-warn);
    --err: var(--brand);
    --bg: #f6f8fa;
    --card: #ffffff;
    --muted: #6b7280;
    --ink: #111827;
    --ink-strong: #0f172a;
    --tab-bg: #fce7ec;
    --tab-border: #f3d0d7;
    --tab-active-bg: #fff;
    --green: #27ae60;
    --green-light: #edfaf3;
    --touch-min: 44px;
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--bg);
    color: var(--ink);
  }

  /* ===== PERSISTENT DISCLAIMER BANNER ===== */
  .disclaimer-bar {
    background: #fff8e1;
    border-bottom: 2px solid var(--brand-lemon);
    padding: 6px 16px;
    font-size: 12px;
    color: #5a4000;
    display: flex;
    align-items: center;
    gap: 8px;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .disclaimer-bar .disc-icon { font-size: 14px; flex-shrink: 0; }

  header {
    background: var(--brand);
    color: #fff;
    padding: 12px 16px;
    font-size: 18px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  header .version { font-size: 11px; opacity: 0.75; font-weight: 400; margin-left: auto; }

  .container { max-width: 980px; margin: 0 auto; padding: 16px; }
  .caption { color: var(--muted); font-size: 14px; line-height: 1.5; margin-bottom: 10px; }

  /* ===== TABS ===== */
  .tabs { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
  .tab {
    background: var(--tab-bg);
    border: 1px solid var(--tab-border);
    color: var(--ink-strong);
    padding: 10px 14px;
    border-radius: 8px;
    cursor: pointer;
    user-select: none;
    font-size: 14px;
    min-height: var(--touch-min);
    display: flex;
    align-items: center;
    transition: background 0.15s, box-shadow 0.15s;
  }
  .tab:hover { background: #fad0d8; }
  .tab.active {
    background: var(--tab-active-bg);
    border-color: var(--brand);
    font-weight: 700;
    box-shadow: 0 0 0 2px color-mix(in oklab, var(--brand) 12%, transparent);
  }
  .tab .tab-badge {
    display: inline-block;
    background: var(--brand);
    color: #fff;
    font-size: 10px;
    padding: 1px 5px;
    border-radius: 99px;
    margin-left: 6px;
    font-weight: 700;
  }

  /* ===== PANELS ===== */
  .panel {
    display: none;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 16px;
    border-top-width: 4px;
    border-top-color: var(--brand-plum);
    animation: fadeIn 0.15s ease;
  }
  .panel.active { display: block; }
  @keyframes fadeIn { from { opacity:0; transform:translateY(4px); } to { opacity:1; transform:translateY(0); } }

  h2 { margin: 0 0 6px 0; font-size: 20px; }
  h3 { margin: 16px 0 8px; font-size: 16px; color: var(--ink-strong); }

  /* ===== LABELS & INPUTS ===== */
  label { font-weight: 600; display: block; margin-top: 12px; }

  .row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  @media (max-width: 720px){ .row { grid-template-columns: 1fr; } }
  .row > * { min-width: 0; }

  input[type="date"], input[type="number"], input[type="text"], select {
    width: 100%;
    padding: 10px;
    border: 1px solid #cbd5e1;
    border-radius: 8px;
    font-size: 15px;
    box-sizing: border-box;
    min-width: 0;
    min-height: var(--touch-min);
  }
  input:focus, select:focus { outline: 2px solid var(--brand); outline-offset: 1px; }

  .help {
    color: var(--muted);
    font-size: 13px;
    margin-top: 4px;
    overflow-wrap: anywhere;
    word-break: break-word;
    max-width: 70ch;
  }

  /* ===== RADIO / CHECKBOX ‚Äî large tap targets ===== */
  .radio-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
  .radio-row label {
    font-weight: 400;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin: 0;
    padding: 8px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    min-height: var(--touch-min);
    background: #fafafa;
    transition: background 0.12s, border-color 0.12s;
  }
  .radio-row label:hover { background: var(--tab-bg); border-color: var(--brand); }
  .radio-row input[type="radio"]:checked + span,
  .radio-row label:has(input:checked) {
    background: var(--tab-bg);
    border-color: var(--brand);
    font-weight: 600;
  }
  .radio-row input[type="radio"],
  .radio-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--brand); }

  /* ===== FIELDSETS ===== */
  .fs {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 10px 12px;
    background: #fff;
    margin-top: 10px;
  }
  .fs > legend {
    padding: 0 6px;
    font-weight: 600;
    color: var(--ink-strong);
    font-size: 14px;
  }
  .legend-note { margin-left: 8px; font-weight: 700; }
  .text-red { color: var(--err); }

  /* ===== BUTTONS ===== */
  .btn {
    margin-top: 14px;
    padding: 12px 16px;
    background: var(--brand);
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    cursor: pointer;
    min-height: var(--touch-min);
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: background 0.15s;
  }
  .btn:hover { background: #c0102f; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn:focus-visible { outline: 3px solid color-mix(in oklab, var(--brand) 30%, transparent); outline-offset: 2px; }
  .btn.btn-secondary {
    background: #fff;
    color: var(--brand);
    border: 1px solid var(--brand);
  }
  .btn.btn-secondary:hover { background: var(--tab-bg); }

  /* ===== RESULT CARDS ===== */
  .result-card {
    border-radius: 10px;
    margin-top: 16px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
  }
  .result-card .rc-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    font-weight: 700;
    font-size: 16px;
  }
  .result-card .rc-icon { font-size: 22px; }
  .result-card .rc-body { padding: 12px 16px; border-top: 1px solid #e5e7eb; background: #fafafa; }
  .result-card .rc-next { padding: 10px 16px; background: #f3f4f6; border-top: 1px solid #e5e7eb; font-size: 13px; }
  .result-card .rc-next strong { display: block; margin-bottom: 4px; }
  .result-card .rc-meta { padding: 10px 16px; border-top: 1px solid #e5e7eb; }
  .result-card .rc-copy {
    padding: 8px 16px;
    background: #f3f4f6;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
  }
  .result-card.rc-meets { border-color: var(--err); }
  .result-card.rc-meets .rc-header { background: #fff1f3; color: var(--err); }
  .result-card.rc-atrisk { border-color: var(--warn); }
  .result-card.rc-atrisk .rc-header { background: #fff7ec; color: #7A3E00; }
  .result-card.rc-clear { border-color: var(--ok); }
  .result-card.rc-clear .rc-header { background: #f3fcf6; color: var(--ok); }

  .kv { margin: 6px 0; font-size: 14px; }
  .kv .k { font-weight: 700; display: inline; }
  .kv-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 16px; }
  @media(max-width:600px){ .kv-grid { grid-template-columns: 1fr; } }

  .muted { color: var(--muted); }

  /* Legacy result classes (kept for compat) */
  .note, .result, .banner {
    border-left: 4px solid #94a3b8; background: #f8fafc; padding: 10px 12px; border-radius: 8px; margin-top: 14px; line-height: 1.6;
  }
  .result.ok { border-left-color: var(--ok); background: #f3fcf6; }
  .result.warn { border-left-color: var(--warn); background: #fff7ec; }
  .result.err { border-left-color: var(--err); background: #fff1f3; }
  .banner.warn { border-left-color: var(--warn); background: #fff7ec; color: #7A3E00; font-weight: 600; }

  details { background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 8px; padding: 10px 12px; margin-top: 12px; }
  summary { font-weight: 600; cursor: pointer; min-height: 30px; display: flex; align-items: center; }

  .divider { height: 1px; background: #e5e7eb; margin: 18px 0; }
  footer { color: #6b7280; font-size: 12px; margin-top: 20px; }

  .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #fff0f3; color: var(--brand); font-size: 12px; margin-left: 4px; }

  /* ===== RIT WARNING ===== */
  .rit-section { margin-top: 16px; }

  /* ===== VAE PANEL ===== */
  .vae-tier {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px;
    margin-top: 10px;
    background: #fafafa;
  }
  .vae-tier.unlocked { background: #f3fcf6; border-color: var(--ok); }
  .vae-tier.locked { opacity: 0.5; pointer-events: none; }
  .vae-tier h4 { margin: 0 0 8px; font-size: 15px; display: flex; align-items: center; gap: 8px; }
  .tier-badge {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 99px;
    font-size: 11px;
    font-weight: 700;
    color: #fff;
    background: #94a3b8;
  }
  .tier-badge.vac { background: #2563eb; }
  .tier-badge.ivac { background: #7c3aed; }
  .tier-badge.pvap { background: var(--brand); }

  /* ===== QUICK CHECK MODE ===== */
  .mode-toggle-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 14px;
    background: #f3f4f6;
    border-radius: 10px;
    padding: 4px;
  }
  .mode-btn {
    flex: 1;
    padding: 8px;
    border: none;
    border-radius: 8px;
    background: transparent;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    color: var(--muted);
    transition: background 0.15s, color 0.15s;
    min-height: 36px;
  }
  .mode-btn.active { background: #fff; color: var(--brand); box-shadow: 0 1px 4px rgba(0,0,0,0.1); }

  /* ===== SSI SPECIFIC ===== */
  .row-comm { grid-template-columns: minmax(260px, 1fr) minmax(320px, 1fr); gap: 18px; }
  @media (max-width: 720px){ .row-comm { grid-template-columns: 1fr; } }

  /* ===== COMPACT LINKS ===== */
  .compact-links a {
    display: inline-flex; align-items: center; gap: 4px; font-weight: 600;
    text-decoration: none; color: var(--brand-eggplant);
    border-bottom: 1px dashed color-mix(in oklab, var(--brand-eggplant) 40%, transparent);
  }
  .compact-links a:hover, .compact-links a:focus { color: var(--brand); border-bottom-color: currentColor; }
  .compact-links a[target="_blank"]::after { content: "‚Üó"; font-size: 0.85em; opacity: 0.75; }

  /* ===== FEEDBACK ===== */
  .feedback-frame {
    display: block; width: 100%; height: 80vh; min-height: 700px; max-height: 90vh;
    border: 0; border-radius: 8px;
  }
  @media (max-width: 480px) { .feedback-frame { height: 70vh; min-height: 520px; } }
  .feedback-qr { width: 200px; height: 200px; object-fit: contain; border: 1px dashed #cbd5e1; border-radius: 8px; padding: 6px; background: #fff; }

  /* ===== PRINT ===== */
  @media print {
    header, .tabs, footer, .caption, .disclaimer-bar { display: none !important; }
    body * { visibility: hidden; }
    #panel-cdiff, #panel-cdiff * { visibility: visible; }
    .panel { display: none !important; }
    #panel-cdiff { display: block !important; }
    #panel-cdiff > * { display: none !important; }
    #cd-print-area { display: block !important; }
    body { background: #fff !important; }
    #cd-print-area { padding: 0.5in; box-shadow: none; }
    .fs, .note, .result, .row, details { break-inside: avoid; page-break-inside: avoid; }
    .divider { height: 0; margin: 8px 0; }
    #cd-print-area { font-size: 13px; line-height: 1.35; }
    #cd-print-area h3 { margin-top: 8px; margin-bottom: 6px; }
    #cd-print-area .btn { display: none !important; }
    .compact-links a[target="_blank"]::after { content: ""; }
    .compact-links a { text-decoration: underline; border: 0; color: #000; }
  }
</style>
</head>
<body>

<!-- Persistent disclaimer -->
<div class="disclaimer-bar">
  <span class="disc-icon">‚öïÔ∏è</span>
  <span><strong>Clinical Decision Support Only:</strong> This tool supports NHSN-aligned surveillance workflows and does not replace clinical judgment, hospital policy, or direct provider consultation. Always verify findings with your Infection Prevention team.</span>
</div>

<header>
  HAI Assistant
  <span class="version">Prisma Health ¬∑ NHSN-Aligned</span>
</header>

<div class="container">
  <div class="caption">
    Device days use calendar-day counting (insertion day = Day 1; eligible on Day 3+). IWP is 7 days anchored on the first positive diagnostic test (¬±3 days). Device association: in place on the DOE or removed the calendar day before.
  </div>

  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="clabsi">CLABSI Risk</div>
    <div class="tab" data-tab="clabsi2">CLABSI Surveillance</div>
    <div class="tab" data-tab="cauti">CAUTI</div>
    <div class="tab" data-tab="vae">VAE</div>
    <div class="tab" data-tab="blood">Blood Cx Escalation</div>
    <div class="tab" data-tab="urine">Urine Cx Escalation</div>
    <div class="tab" data-tab="cdiff">C. diff Ticket</div>
    <div class="tab" data-tab="ssi">SSI Risk</div>
    <div class="tab" data-tab="feedback">Feedback</div>
  </div>

  <!-- ============================================================
       CLABSI RISK
  ============================================================ -->
  <section class="panel active" id="panel-clabsi">
    <h2>CLABSI Risk</h2>

    <!-- Mode toggle -->
    <div class="mode-toggle-bar">
      <button class="mode-btn active" id="clabsi-mode-quick" onclick="setMode('clabsi','quick')">‚ö° Quick Check</button>
      <button class="mode-btn" id="clabsi-mode-full" onclick="setMode('clabsi','full')">üî¨ Full Criteria</button>
    </div>

    <div id="clabsi-quick-mode">
      <div class="help" style="margin-bottom:10px;">Answer 3 questions for a rapid eligibility screen.</div>
      <fieldset class="fs">
        <legend>Central line in place &gt;2 calendar days?</legend>
        <div class="radio-row">
          <label><input type="radio" name="clq-eligible" value="Yes" /> <span>Yes (&gt;2 days)</span></label>
          <label><input type="radio" name="clq-eligible" value="No" checked /> <span>No (‚â§2 days)</span></label>
        </div>
      </fieldset>
      <fieldset class="fs">
        <legend>Positive blood culture?</legend>
        <div class="radio-row">
          <label><input type="radio" name="clq-bcx" value="Yes" /> <span>Yes</span></label>
          <label><input type="radio" name="clq-bcx" value="No" checked /> <span>No</span></label>
        </div>
      </fieldset>
      <fieldset class="fs">
        <legend>BSI secondary to another confirmed infection site?</legend>
        <div class="radio-row">
          <label><input type="radio" name="clq-secondary" value="Yes" /> <span>Yes (secondary BSI)</span></label>
          <label><input type="radio" name="clq-secondary" value="No" checked /> <span>No / Unknown</span></label>
        </div>
      </fieldset>
      <button class="btn" id="clq-run">Quick Check</button>
      <div id="clq-result"></div>
    </div>

    <div id="clabsi-full-mode" style="display:none;">
      <div class="row">
        <div>
          <label for="cl-insert">Central line insertion date</label>
          <input type="date" id="cl-insert" aria-describedby="cl-insert-help"/>
          <div id="cl-insert-help" class="help">Insertion day = Day 1. Eligible starting Day 3.</div>
        </div>
        <div>
          <label for="cl-assess">Assessment / DOE</label>
          <input type="date" id="cl-assess" aria-describedby="cl-assess-help"/>
          <div id="cl-assess-help" class="help">Date of first element used to meet CLABSI criterion.</div>
        </div>
      </div>

      <fieldset class="fs">
        <legend>Device status on DOE</legend>
        <div class="radio-row" id="cl-inplace-row">
          <label><input type="radio" name="cl-inplace" value="Yes" /> <span>In place</span></label>
          <label><input type="radio" name="cl-inplace" value="No" /> <span>Not in place</span></label>
        </div>
      </fieldset>

      <div id="cl-removal-wrap" style="display:none;">
        <label for="cl-removal">Central line removal date</label>
        <input type="date" id="cl-removal"/>
        <div id="cl-eligibility-banner" class="banner warn" style="display:none;" role="alert" aria-live="assertive">
          ‚ö†Ô∏è Device not eligible ‚Äî must be in place &gt;2 calendar days.
        </div>
      </div>

      <!-- RIT check -->
      <div class="rit-section">
        <fieldset class="fs">
          <legend>Prior CLABSI event (RIT check)? <span class="pill">14-day RIT</span></legend>
          <div class="radio-row">
            <label><input type="radio" name="cl-rit" value="Yes" /> <span>Yes ‚Äî prior CLABSI reported</span></label>
            <label><input type="radio" name="cl-rit" value="No" checked /> <span>No prior event</span></label>
          </div>
        </fieldset>
        <div id="cl-rit-date-wrap" style="display:none;">
          <label for="cl-rit-date">Date of prior CLABSI (DOE)</label>
          <input type="date" id="cl-rit-date"/>
          <div id="cl-rit-banner" class="banner warn" style="display:none;" role="alert" aria-live="assertive">
            ‚ö†Ô∏è Within 14-day RIT window ‚Äî this event may not be separately reportable.
          </div>
        </div>
      </div>

      <h3>Microbiology timing <span class="pill">IWP: 7 days</span></h3>
      <div class="radio-row">
        <label><input type="checkbox" id="cl-use-bcx" /> <span>Specify first positive blood culture date</span></label>
      </div>
      <div id="cl-bcx-wrap" style="display:none;">
        <label for="cl-bcx">First positive blood culture date</label>
        <input type="date" id="cl-bcx" />
      </div>
      <div id="cl-iwp-hint" class="help" style="margin-top:6px;">(set DOE or culture date)</div>

      <div class="divider"></div>
      <h3>Signs &amp; Symptoms within IWP</h3>
      <div class="row">
        <div>
          <label for="cl-tempf">Highest temperature during IWP (¬∞F)</label>
          <input type="number" id="cl-tempf" step="0.1" min="80" max="113" value="98.6" inputmode="decimal"/>
          <div class="help">Fever: strictly &gt;38¬∞C (&gt;100.4¬∞F)</div>
          <div id="cl-tempc" class="muted"></div>
        </div>
        <div></div>
      </div>
      <fieldset class="fs">
        <legend>Hypotension</legend>
        <div class="radio-row">
          <label><input type="radio" name="cl-hypo" value="Yes" /> <span>Present</span></label>
          <label><input type="radio" name="cl-hypo" value="No" checked/> <span>No</span></label>
        </div>
      </fieldset>
      <fieldset class="fs">
        <legend>Chills</legend>
        <div class="radio-row">
          <label><input type="radio" name="cl-chills" value="Yes" /> <span>Present</span></label>
          <label><input type="radio" name="cl-chills" value="No" checked/> <span>No</span></label>
        </div>
      </fieldset>
      <fieldset class="fs">
        <legend>Positive blood culture</legend>
        <div class="radio-row">
          <label><input type="radio" name="cl-bcxpos" value="Yes" /> <span>Yes</span></label>
          <label><input type="radio" name="cl-bcxpos" value="No" checked/> <span>No</span></label>
        </div>
      </fieldset>

      <!-- Transfer attribution -->
      <fieldset class="fs" style="margin-top:12px; border-color:#b8860b;">
        <legend>Unit Attribution</legend>
        <div class="radio-row">
          <label><input type="radio" name="cl-transfer" value="Yes" /> <span>Patient was in this unit on the DOE</span></label>
          <label><input type="radio" name="cl-transfer" value="No" /> <span>Patient transferred from another unit</span></label>
        </div>
        <div class="help">NHSN attributes CLABSI to the location where the patient was on the DOE. If transferred, notify the originating unit's IP representative.</div>
      </fieldset>

      <button class="btn" id="cl-run">Calculate CLABSI</button>
      <div id="cl-result" role="status" aria-live="polite"></div>
    </div>
  </section>

  <!-- ============================================================
       CLABSI SURVEILLANCE
  ============================================================ -->
  <section class="panel" id="panel-clabsi2">
    <h2>CLABSI Surveillance</h2>
    <div class="help">Organism-driven surveillance helper. Common commensals (skin flora) require ‚â•2 positive cultures on separate occasions plus symptoms (LCBI-2/3).</div>

    <div class="row">
      <div>
        <label for="cl2-insert">Central line insertion date</label>
        <input type="date" id="cl2-insert"/>
        <div class="help">Day 1 = insertion day. Eligible starting Day 3.</div>
      </div>
      <div>
        <label for="cl2-assess">Assessment / DOE</label>
        <input type="date" id="cl2-assess"/>
      </div>
    </div>

    <fieldset class="fs">
      <legend>Device status on DOE</legend>
      <div class="radio-row" id="cl2-inplace-row">
        <label><input type="radio" name="cl2-inplace" value="Yes" /> <span>In place</span></label>
        <label><input type="radio" name="cl2-inplace" value="No" /> <span>Not in place</span></label>
      </div>
    </fieldset>

    <div id="cl2-removal-wrap" style="display:none;">
      <label for="cl2-removal">Central line removal date</label>
      <input type="date" id="cl2-removal"/>
      <div id="cl2-eligibility-banner" class="banner warn" style="display:none;" role="alert" aria-live="assertive">
        ‚ö†Ô∏è Device not eligible ‚Äî must be in place &gt;2 calendar days.
      </div>
    </div>

    <!-- RIT for CL2 -->
    <div class="rit-section">
      <fieldset class="fs">
        <legend>Prior CLABSI event (RIT check)? <span class="pill">14-day RIT</span></legend>
        <div class="radio-row">
          <label><input type="radio" name="cl2-rit" value="Yes" /> <span>Yes</span></label>
          <label><input type="radio" name="cl2-rit" value="No" checked /> <span>No</span></label>
        </div>
      </fieldset>
      <div id="cl2-rit-date-wrap" style="display:none;">
        <label for="cl2-rit-date">Date of prior CLABSI (DOE)</label>
        <input type="date" id="cl2-rit-date"/>
        <div id="cl2-rit-banner" class="banner warn" style="display:none;" role="alert" aria-live="assertive">
          ‚ö†Ô∏è Within 14-day RIT window ‚Äî this event may not be separately reportable.
        </div>
      </div>
    </div>

    <h3>Microbiology timing <span class="pill">IWP: 7 days</span></h3>
    <div class="radio-row">
      <label><input type="checkbox" id="cl2-use-bcx" /> <span>Specify first positive blood culture date</span></label>
    </div>
    <div id="cl2-bcx-wrap" style="display:none;">
      <label for="cl2-bcx">First positive blood culture date</label>
      <input type="date" id="cl2-bcx" />
    </div>
    <div id="cl2-iwp-hint" class="help" style="margin-top:6px;">(set DOE or culture date)</div>

    <div class="divider"></div>
    <h3>Organism</h3>
    <label for="cl2-organism">Select organism</label>
    <select id="cl2-organism"></select>
    <div class="help">Skin flora/commensals will reveal additional criteria fields.</div>

    <div id="cl2-sx-wrap" style="display:none;">
      <h3>Symptoms (required for selected organism ‚Äî LCBI 2/3)</h3>
      <div class="row">
        <div>
          <label for="cl2-tempf">Highest temperature during IWP (¬∞F)</label>
          <input type="number" id="cl2-tempf" step="0.1" min="80" max="113" value="98.6" inputmode="decimal"/>
          <div class="help">Fever: strictly &gt;38¬∞C</div>
          <div id="cl2-tempc" class="muted"></div>
        </div>
        <div></div>
      </div>
      <fieldset class="fs">
        <legend>Hypotension</legend>
        <div class="radio-row">
          <label><input type="radio" name="cl2-hypo" value="Yes" /> <span>Present</span></label>
          <label><input type="radio" name="cl2-hypo" value="No" checked/> <span>No</span></label>
        </div>
      </fieldset>
      <fieldset class="fs">
        <legend>Chills</legend>
        <div class="radio-row">
          <label><input type="radio" name="cl2-chills" value="Yes" /> <span>Present</span></label>
          <label><input type="radio" name="cl2-chills" value="No" checked/> <span>No</span></label>
        </div>
      </fieldset>
    </div>

    <fieldset class="fs" style="margin-top:10px;">
      <legend>Blood culture result</legend>
      <div class="radio-row">
        <label><input type="radio" name="cl2-bcxpos" value="Yes" /> <span>Positive</span></label>
        <label><input type="radio" name="cl2-bcxpos" value="No" checked/> <span>No</span></label>
      </div>
    </fieldset>

    <!-- MBI-LCBI check -->
    <div id="cl2-mbi-wrap" style="display:none;">
      <fieldset class="fs" style="border-color: #b8860b; background:#fffdf0;">
        <legend>MBI-LCBI Screening (intestinal organisms detected)</legend>
        <div class="help" style="margin-bottom:8px;">If the organism is intestinal-type AND the patient meets an MBI condition, flag as MBI-LCBI ‚Äî still reportable but may be excluded from SIR.</div>
        <div class="radio-row">
          <label><input type="checkbox" id="cl2-mbi-hsct" /> <span>Allogeneic HSCT with GvHD Grade III/IV</span></label>
        </div>
        <div class="radio-row" style="margin-top:6px;">
          <label><input type="checkbox" id="cl2-mbi-neutro" /> <span>Neutropenia: ANC or WBC &lt;500 cells/ŒºL for &gt;2 consecutive days adjacent to DOE</span></label>
        </div>
      </fieldset>
    </div>

    <div id="cl2-comm-wrap" style="display:none;">
      <h3>Commensal Culture Requirements</h3>
      <div class="row row-comm">
        <div>
          <label for="cl2-bcxcount">Number of positive cultures (same organism)</label>
          <input type="number" id="cl2-bcxcount" min="1" step="1" value="1"/>
          <div class="help">
              NHSN requires ‚â•2 positive blood cultures with the same common commensal.
              <a href="https://www.cdc.gov/nhsn/pdfs/checklists/2025-NHSN-Laboratory-Confirmed-Bloodstream-Infection-LCBI-Checklist.pdf" target="_blank" rel="noopener">[1] NHSN LCBI Checklist</a>
            </div>
        </div>
        <div>
          <fieldset class="fs">
              <legend>Collected on separate occasions?</legend>
              <div class="radio-row" id="cl2-sep-row">
                <label><input type="radio" name="cl2-sep" value="Yes" /> <span>Yes (same or consecutive days)</span></label>
                <label><input type="radio" name="cl2-sep" value="No" checked/> <span>No</span></label>
              </div>
              <p id="cl2-sep-help" class="help">
                Cultures must be collected on separate occasions (same or consecutive days).
                <a href="https://www.cdph.ca.gov/Programs/CHCQ/HAI/CDPH%20Document%20Library/2019_17h_CLABSI.Surveillance_Approved02.22.19.pdf" target="_blank" rel="noopener">[2] CDPH CLABSI Surveillance</a>
              </p>
            </fieldset>
        </div>
      </div>
    </div>

    <!-- Transfer attribution -->
    <fieldset class="fs" style="margin-top:12px; border-color:#b8860b;">
      <legend>Unit Attribution</legend>
      <div class="radio-row">
        <label><input type="radio" name="cl2-transfer" value="Yes" /> <span>Patient was in this unit on the DOE</span></label>
        <label><input type="radio" name="cl2-transfer" value="No" /> <span>Patient transferred from another unit</span></label>
      </div>
      <div class="help">NHSN attributes CLABSI to the location where the patient was on the DOE.</div>
    </fieldset>

    <button class="btn" id="cl2-run">Calculate CLABSI</button>
    <div id="cl2-result" role="status" aria-live="polite"></div>
  </section>

  <!-- ============================================================
       CAUTI
  ============================================================ -->
  <section class="panel" id="panel-cauti">
    <h2>CAUTI</h2>

    <!-- Mode toggle -->
    <div class="mode-toggle-bar">
      <button class="mode-btn active" id="cauti-mode-quick" onclick="setMode('cauti','quick')">‚ö° Quick Check</button>
      <button class="mode-btn" id="cauti-mode-full" onclick="setMode('cauti','full')">üî¨ Full Criteria</button>
    </div>

    <div id="cauti-quick-mode">
      <div class="help" style="margin-bottom:10px;">Answer 4 questions for a rapid eligibility screen.</div>
      <fieldset class="fs">
        <legend>Indwelling catheter in place &gt;2 calendar days?</legend>
        <div class="radio-row">
          <label><input type="radio" name="cauq-eligible" value="Yes" /> <span>Yes</span></label>
          <label><input type="radio" name="cauq-eligible" value="No" checked /> <span>No</span></label>
        </div>
      </fieldset>
      <fieldset class="fs">
        <legend>Positive urine culture (‚â§2 organisms, ‚â•10‚Åµ CFU/mL)?</legend>
        <div class="radio-row">
          <label><input type="radio" name="cauq-ucx" value="Yes" /> <span>Yes</span></label>
          <label><input type="radio" name="cauq-ucx" value="No" checked /> <span>No</span></label>
        </div>
      </fieldset>
      <fieldset class="fs">
        <legend>Qualifying symptom present?</legend>
        <div class="radio-row">
          <label><input type="radio" name="cauq-sx" value="Yes" /> <span>Yes (fever, suprapubic tenderness, CVA pain)</span></label>
          <label><input type="radio" name="cauq-sx" value="No" checked /> <span>No</span></label>
        </div>
      </fieldset>
      <button class="btn" id="cauq-run">Quick Check</button>
      <div id="cauq-result"></div>
    </div>

    <div id="cauti-full-mode" style="display:none;">
      <div class="row">
        <div>
          <label for="cu-insert">Current catheter insertion date</label>
          <input type="date" id="cu-insert"/>
          <div class="help">Day 1 = insertion day. Eligible starting Day 3.</div>
        </div>
        <div>
          <label for="cu-assess">Assessment / DOE</label>
          <input type="date" id="cu-assess"/>
        </div>
      </div>

      <!-- Prior catheter toggle -->
      <div class="radio-row" style="margin-top:10px;">
        <label><input type="checkbox" id="cu-prior-enable" /> <span>Prior catheter was in place before this one (e.g. removed and replaced)</span></label>
      </div>
      <div id="cu-prior-wrap" style="display:none; margin-top:8px;">
        <fieldset class="fs" style="border-color:#2980b9; background:#f0f8ff;">
          <legend>Prior Catheter</legend>
          <div class="help" style="margin-bottom:10px;">
            Per NHSN, device-days accumulate across catheters when a Foley is removed and replaced. Enter the <strong>earliest</strong> insertion date to calculate total combined dwell time for eligibility. Device association is still evaluated against the current catheter.
          </div>
          <label for="cu-prior-insert">Prior catheter insertion date</label>
          <input type="date" id="cu-prior-insert"/>
          <div class="help">The eligibility day count will use this earlier date instead of the current catheter insertion date.</div>
        </fieldset>
      </div>

      <fieldset class="fs">
        <legend>Device status on DOE</legend>
        <div class="radio-row" id="cu-inplace-row">
          <label><input type="radio" name="cu-inplace" value="Yes" /> <span>In place</span></label>
          <label><input type="radio" name="cu-inplace" value="No" /> <span>Not in place</span></label>
        </div>
      </fieldset>

      <label for="cu-removal">Date of catheter removal</label>
      <input type="date" id="cu-removal"/>
      <div id="cu-eligibility-banner" class="banner warn" style="display:none;" role="alert" aria-live="assertive">
        ‚ö†Ô∏è Device not eligible ‚Äî must be in place &gt;2 calendar days.
      </div>

      <!-- RIT check -->
      <div class="rit-section">
        <fieldset class="fs">
          <legend>Prior CAUTI/UTI event (RIT check)? <span class="pill">14-day RIT</span></legend>
          <div class="radio-row">
            <label><input type="radio" name="cu-rit" value="Yes" /> <span>Yes ‚Äî prior event reported</span></label>
            <label><input type="radio" name="cu-rit" value="No" checked /> <span>No prior event</span></label>
          </div>
        </fieldset>
        <div id="cu-rit-date-wrap" style="display:none;">
          <label for="cu-rit-date">Date of prior UTI event (DOE)</label>
          <input type="date" id="cu-rit-date"/>
          <div id="cu-rit-banner" class="banner warn" style="display:none;" role="alert" aria-live="assertive">
            ‚ö†Ô∏è Within 14-day RIT window ‚Äî this event may not be separately reportable.
          </div>
        </div>
      </div>

      <h3>Microbiology timing <span class="pill">IWP: 7 days</span></h3>
      <div class="radio-row">
        <label><input type="checkbox" id="cu-use-ucx" checked /> <span>Specify urine culture date (IWP anchor)</span></label>
      </div>
      <div id="cu-ucx-wrap">
        <label for="cu-ucx">Urine culture collection date</label>
        <input type="date" id="cu-ucx" />
      </div>
      <div id="cu-iwp-hint" class="help" style="margin-top:6px;">(set DOE or culture date)</div>

      <div class="divider"></div>

      <div id="cu-suti-section">
        <h3>Signs &amp; Symptoms within IWP (SUTI)</h3>
        <div class="note" id="cu-catheter-in-place-note" style="display:none;">
          ‚ÑπÔ∏è Catheter in place on DOE: urgency, frequency, and dysuria are excluded by NHSN.
        </div>
        <div class="row">
          <div>
            <label for="cu-tempf">Highest temperature during IWP (¬∞F)</label>
            <input type="number" id="cu-tempf" step="0.1" min="80" max="113" value="98.6" inputmode="decimal"/>
            <div class="help">Fever: strictly &gt;38¬∞C (&gt;100.4¬∞F)</div>
            <div id="cu-tempc" class="muted"></div>
          </div>
          <div></div>
        </div>
        <fieldset class="fs">
          <legend>Suprapubic tenderness</legend>
          <div class="radio-row">
            <label><input type="radio" name="cu-supra" value="Yes" /> <span>Yes</span></label>
            <label><input type="radio" name="cu-supra" value="No" checked/> <span>No</span></label>
          </div>
        </fieldset>
        <fieldset class="fs">
          <legend>CVA pain/tenderness (flank)</legend>
          <div class="radio-row">
            <label><input type="radio" name="cu-cva" value="Yes" /> <span>Yes</span></label>
            <label><input type="radio" name="cu-cva" value="No" checked/> <span>No</span></label>
          </div>
        </fieldset>
        <fieldset class="fs">
          <legend>Lower urinary tract symptoms (only if catheter removed)</legend>
          <div class="radio-row">
            <label><input type="radio" name="cu-urg" value="Yes" /> <span>Urgency</span></label>
            <label><input type="radio" name="cu-urg" value="No" checked/> <span>No</span></label>
          </div>
          <div class="radio-row" style="margin-top:4px;">
            <label><input type="radio" name="cu-freq" value="Yes" /> <span>Frequency</span></label>
            <label><input type="radio" name="cu-freq" value="No" checked/> <span>No</span></label>
          </div>
          <div class="radio-row" style="margin-top:4px;">
            <label><input type="radio" name="cu-dys" value="Yes" /> <span>Dysuria</span></label>
            <label><input type="radio" name="cu-dys" value="No" checked/> <span>No</span></label>
          </div>
        </fieldset>
      </div>

      <fieldset class="fs">
        <legend>Urine culture result</legend>
        <div class="radio-row">
          <label><input type="radio" name="cu-ucxpos" value="Yes" /> <span>Positive (‚â§2 organisms, ‚â•10‚Åµ CFU/mL)</span></label>
          <label><input type="radio" name="cu-ucxpos" value="No" checked/> <span>No</span></label>
        </div>
      </fieldset>

      <!-- Transfer attribution -->
      <fieldset class="fs" style="margin-top:12px; border-color:#b8860b;">
        <legend>Unit Attribution</legend>
        <div class="radio-row">
          <label><input type="radio" name="cu-transfer" value="Yes" /> <span>Patient was in this unit on the DOE</span></label>
          <label><input type="radio" name="cu-transfer" value="No" /> <span>Patient transferred from another unit</span></label>
        </div>
        <div class="help">NHSN attributes CAUTI to the location where the patient was on the DOE.</div>
      </fieldset>

      <button class="btn" id="cu-run">Calculate CAUTI</button>
      <div id="cu-result" role="status" aria-live="polite"></div>
    </div>
  </section>

  <!-- ============================================================
       VAE ‚Äî NEW TAB
  ============================================================ -->
  <section class="panel" id="panel-vae">
    <h2>VAE ‚Äî Ventilator-Associated Events</h2>
    <div class="help">NHSN VAE surveillance uses a tiered algorithm: VAC ‚Üí IVAC ‚Üí PVAP. Each tier builds on the previous. Enter data below to evaluate.</div>

    <div class="note" style="border-left-color:#2563eb; background:#eff6ff;">
      <strong>VAE Surveillance Overview:</strong> The NHSN VAE algorithm requires a patient to be on mechanical ventilation for ‚â•2 calendar days before any event can be recognized.
      <ul style="margin-top:6px; padding-left:18px; font-size:13px;">
        <li><strong>VAC</strong> (Ventilator-Associated Condition): Worsening oxygenation after a stable/improving period</li>
        <li><strong>IVAC</strong> (Infection-related VAC): VAC + signs of infection (temperature/WBC abnormality + new antimicrobial)</li>
        <li><strong>PVAP</strong> (Possible VAP): IVAC + positive respiratory culture or other respiratory criteria</li>
      </ul>
    </div>

    <div class="divider"></div>

    <!-- Vent days -->
    <div class="row">
      <div>
        <label for="vae-vent-start">Mechanical ventilation start date</label>
        <input type="date" id="vae-vent-start"/>
        <div class="help">Day 1 = first day of ventilation. Event eligible starting Day 3.</div>
      </div>
      <div>
        <label for="vae-assess">Assessment date (potential event date)</label>
        <input type="date" id="vae-assess"/>
      </div>
    </div>
    <div id="vae-ventdays-display" class="help" style="margin-top:6px;"></div>

    <div class="divider"></div>

    <!-- TIER 1: VAC -->
    <div class="vae-tier" id="vae-tier-vac">
      <h4><span class="tier-badge vac">Tier 1</span> VAC ‚Äî Ventilator-Associated Condition</h4>
      <div class="help" style="margin-bottom:8px;">
        After ‚â•2 calendar days of stable or improving FiO‚ÇÇ/PEEP, there must be a sustained worsening (‚â•2 calendar days) in oxygenation:
        increase in daily minimum FiO‚ÇÇ by ‚â•0.20 <strong>OR</strong> increase in daily minimum PEEP by ‚â•3 cmH‚ÇÇO.
      </div>
      <fieldset class="fs">
        <legend>Baseline stable/improving period ‚â•2 calendar days?</legend>
        <div class="radio-row">
          <label><input type="radio" name="vac-baseline" value="Yes" /> <span>Yes</span></label>
          <label><input type="radio" name="vac-baseline" value="No" checked /> <span>No</span></label>
        </div>
      </fieldset>
      <fieldset class="fs">
        <legend>Oxygenation worsening criterion met?</legend>
        <div class="radio-row">
          <label><input type="radio" name="vac-worsen" value="fio2" /> <span>FiO‚ÇÇ increased ‚â•0.20 for ‚â•2 days</span></label>
          <label><input type="radio" name="vac-worsen" value="peep" /> <span>PEEP increased ‚â•3 cmH‚ÇÇO for ‚â•2 days</span></label>
          <label><input type="radio" name="vac-worsen" value="No" checked /> <span>Neither</span></label>
        </div>
      </fieldset>
    </div>

    <!-- TIER 2: IVAC -->
    <div class="vae-tier locked" id="vae-tier-ivac">
      <h4><span class="tier-badge ivac">Tier 2</span> IVAC ‚Äî Infection-Related VAC</h4>
      <div class="help" style="margin-bottom:8px;">
        VAC criteria met PLUS, on days 2 or 3 of the worsening window: temperature &gt;38¬∞C or &lt;36¬∞C OR WBC ‚â•12,000 or ‚â§4,000 cells/mm¬≥, AND a new antimicrobial agent started and continued ‚â•4 days.
      </div>
      <fieldset class="fs">
        <legend>Temperature or WBC abnormality on VAC day 2 or 3?</legend>
        <div class="radio-row">
          <label><input type="radio" name="ivac-tempwbc" value="Yes" /> <span>Yes</span></label>
          <label><input type="radio" name="ivac-tempwbc" value="No" checked /> <span>No</span></label>
        </div>
      </fieldset>
      <fieldset class="fs">
        <legend>New antimicrobial started ‚â•4 days?</legend>
        <div class="radio-row">
          <label><input type="radio" name="ivac-abx" value="Yes" /> <span>Yes</span></label>
          <label><input type="radio" name="ivac-abx" value="No" checked /> <span>No</span></label>
        </div>
      </fieldset>
    </div>

    <!-- TIER 3: PVAP -->
    <div class="vae-tier locked" id="vae-tier-pvap">
      <h4><span class="tier-badge pvap">Tier 3</span> PVAP ‚Äî Possible VAP</h4>
      <div class="help" style="margin-bottom:8px;">
        IVAC criteria met PLUS positive respiratory culture, purulent secretions, or pathological/imaging evidence of pneumonia on days 2 or 3 of worsening window.
      </div>
      <fieldset class="fs">
        <legend>Qualifying respiratory criteria?</legend>
        <div class="radio-row">
          <label><input type="checkbox" id="pvap-culture" /> <span>Positive respiratory culture (‚â•10¬≥ CFU/mL from BAL, ‚â•10‚Åµ from endotracheal aspirate)</span></label>
        </div>
        <div class="radio-row" style="margin-top:6px;">
          <label><input type="checkbox" id="pvap-purulent" /> <span>Purulent respiratory secretions (‚â•25 PMNs AND ‚â§10 squamous cells per LPF)</span></label>
        </div>
        <div class="radio-row" style="margin-top:6px;">
          <label><input type="checkbox" id="pvap-imaging" /> <span>New/progressive infiltrate, consolidation, cavitation, or pneumatocele on imaging</span></label>
        </div>
      </fieldset>
    </div>

    <!-- RIT for VAE -->
    <div class="rit-section">
      <fieldset class="fs">
        <legend>Prior VAE event (RIT check)? <span class="pill">14-day RIT</span></legend>
        <div class="radio-row">
          <label><input type="radio" name="vae-rit" value="Yes" /> <span>Yes</span></label>
          <label><input type="radio" name="vae-rit" value="No" checked /> <span>No</span></label>
        </div>
      </fieldset>
      <div id="vae-rit-date-wrap" style="display:none;">
        <label for="vae-rit-date">Date of prior VAE event</label>
        <input type="date" id="vae-rit-date"/>
        <div id="vae-rit-banner" class="banner warn" style="display:none;" role="alert" aria-live="assertive">
          ‚ö†Ô∏è Within 14-day RIT window ‚Äî this event may not be separately reportable.
        </div>
      </div>
    </div>

    <button class="btn" id="vae-run">Calculate VAE</button>
    <div id="vae-result" role="status" aria-live="polite"></div>
  </section>

  <!-- ============================================================
       BLOOD CULTURE ESCALATION
  ============================================================ -->
  <section class="panel" id="panel-blood">
    <h2>Blood Culture Escalation</h2>
    <div class="help">Quick pathway to determine whether to obtain a blood culture or escalate for leadership review.</div>

    <fieldset class="fs">
      <legend>Current device</legend>
      <div class="radio-row">
        <label><input type="radio" name="bc-hascvc" value="Yes" /> <span>Patient currently has a CVC</span></label>
        <label><input type="radio" name="bc-hascvc" value="No" checked/> <span>No CVC</span></label>
      </div>
    </fieldset>

    <div id="bc-when-yes">
      <fieldset class="fs">
        <legend>Admit &lt;2 Calendar Days? <span class="legend-note text-red">(Admit Day = Calendar Day 1)</span></legend>
        <div class="radio-row">
          <label><input type="radio" name="bc-recentadm" value="Yes" /> <span>Yes</span></label>
          <label><input type="radio" name="bc-recentadm" value="No" checked/> <span>No</span></label>
        </div>
      </fieldset>
      <div class="result ok" id="bc-out-yes" style="display:none;" role="status" aria-live="polite"></div>
    </div>

    <div id="bc-when-no" style="display:none;">
      <fieldset class="fs">
        <legend>Had a CVC within last 3 calendar days?</legend>
        <div class="radio-row">
          <label><input type="radio" name="bc-recentcvc" value="Yes" /> <span>Yes</span></label>
          <label><input type="radio" name="bc-recentcvc" value="No" checked/> <span>No</span></label>
        </div>
      </fieldset>
      <div class="result ok" id="bc-out-no" style="display:none;" role="status" aria-live="polite"></div>
    </div>

    <details>
      <summary>Things to Remember</summary>
      <ul>
        <li>Does the patient have a wound? If yes, consider a wound culture.</li>
        <li>Any fevers greater than 100.4¬∞F?</li>
        <li>Hypotensive or tachycardic?</li>
        <li>Any other known sources of infection?</li>
      </ul>
    </details>
  </section>

  <!-- ============================================================
       URINE CULTURE ESCALATION
  ============================================================ -->
  <section class="panel" id="panel-urine">
    <h2>Urine Culture Escalation</h2>
    <div class="help">Pathway to guide appropriate urine culture ordering and when to involve unit leadership.</div>

    <fieldset class="fs">
      <legend>Current device</legend>
      <div class="radio-row">
        <label><input type="radio" name="uc-hasfoley" value="Yes" /> <span>Patient currently has a Foley catheter</span></label>
        <label><input type="radio" name="uc-hasfoley" value="No" checked/> <span>No Foley</span></label>
      </div>
    </fieldset>

    <div id="uc-when-yes">
      <fieldset class="fs">
        <legend>Admit &lt;2 Calendar Days? <span class="legend-note text-red">(Admit Day = Calendar Day 1)</span></legend>
        <div class="radio-row">
          <label><input type="radio" name="uc-recentadm" value="Yes" /> <span>Yes</span></label>
          <label><input type="radio" name="uc-recentadm" value="No" checked/> <span>No</span></label>
        </div>
      </fieldset>
      <div class="result ok" id="uc-out-yes" style="display:none;" role="status" aria-live="polite"></div>
    </div>

    <div id="uc-when-no" style="display:none;">
      <fieldset class="fs">
        <legend>Foley within last 3 calendar days?</legend>
        <div class="radio-row">
          <label><input type="radio" name="uc-recentfoley" value="Yes" /> <span>Yes</span></label>
          <label><input type="radio" name="uc-recentfoley" value="No" checked/> <span>No</span></label>
        </div>
      </fieldset>
      <div class="result ok" id="uc-out-no" style="display:none;" role="status" aria-live="polite"></div>
    </div>

    <details>
      <summary>Things to Remember</summary>
      <ul>
        <li>Are urinary symptoms present (dysuria, suprapubic pain, flank pain)?</li>
        <li>Any systemic signs (fever, hypotension, tachycardia)?</li>
        <li>Could this represent asymptomatic bacteriuria?</li>
        <li>Is there another identifiable source of infection?</li>
      </ul>
    </details>
  </section>

  <!-- ============================================================
       C. DIFF TICKET
  ============================================================ -->
  <section class="panel" id="panel-cdiff">
    <h2>C. diff "Ticket to Test"</h2>
    <div class="help compact-links">
      <a href="GMH-Cdiff-Ticket.docx" download>Download GMH C. diff Ticket (.docx)</a>
    </div>

    <fieldset class="fs">
      <legend>Dates</legend>
      <div class="row">
        <div>
          <label for="cd-admit">Admission date</label>
          <input type="date" id="cd-admit" />
        </div>
        <div>
          <label for="cd-collect">Planned stool collection date</label>
          <input type="date" id="cd-collect" />
        </div>
      </div>
      <div class="help" id="cd-hospday-hint">(hospitalization day will be calculated)</div>
      <div id="cd-day4-banner" class="banner warn" style="display:none;" role="alert" aria-live="assertive">
        ‚ö†Ô∏è Stool collection on hospital day ‚â•4 ‚Äî discuss with the ordering provider before collecting.
      </div>
    </fieldset>

    <div class="divider"></div>
    <h3>Diarrhea &amp; stool characteristics</h3>
    <fieldset class="fs">
      <legend>New onset diarrhea</legend>
      <div class="radio-row">
        <label><input type="radio" name="cd-newdiarrhea" value="Yes" /> <span>Yes ‚Äî new onset</span></label>
        <label><input type="radio" name="cd-newdiarrhea" value="No" checked /> <span>No / unclear</span></label>
      </div>
    </fieldset>
    <fieldset class="fs">
      <legend>Unformed stools (last 24 h)</legend>
      <label for="cd-stoolcount">Number of unformed stools (conform to container)</label>
      <input type="number" id="cd-stoolcount" min="0" step="1" value="0" />
      <div class="help">Testing typically requires ‚â•3 unformed stools within 24 h.</div>
    </fieldset>
    <fieldset class="fs">
      <legend>Bristol Stool Chart type</legend>
      <div class="radio-row">
        <label><input type="radio" name="cd-bristol" value="1" /> <span>1</span></label>
        <label><input type="radio" name="cd-bristol" value="2" /> <span>2</span></label>
        <label><input type="radio" name="cd-bristol" value="3" /> <span>3</span></label>
        <label><input type="radio" name="cd-bristol" value="4" /> <span>4</span></label>
        <label><input type="radio" name="cd-bristol" value="5" /> <span>5</span></label>
        <label><input type="radio" name="cd-bristol" value="6" /> <span>6</span></label>
        <label><input type="radio" name="cd-bristol" value="7" /> <span>7</span></label>
      </div>
      <div class="help">C. diff testing is most appropriate with stool types 6‚Äì7.</div>
    </fieldset>

    <div class="divider"></div>
    <h3>Other symptoms (supportive)</h3>
    <fieldset class="fs">
      <legend>Check all that apply (optional)</legend>
      <div class="radio-row">
        <label><input type="checkbox" id="cd-sx-wbc" /> <span>Increased WBCs</span></label>
        <label><input type="checkbox" id="cd-sx-pain" /> <span>Abdominal pain</span></label>
        <label><input type="checkbox" id="cd-sx-fever" /> <span>Fever</span></label>
      </div>
    </fieldset>

    <div class="divider"></div>
    <h3>Potential confounders / alternatives</h3>
    <fieldset class="fs">
      <legend>Recent meds / prep</legend>
      <div class="radio-row">
        <label><input type="checkbox" id="cd-lax-24h" /> <span>Laxatives or stool softeners in last 24 h</span></label>
        <label><input type="checkbox" id="cd-prep-48h" /> <span>Bowel prep or enema in last 48 h</span></label>
      </div>
      <div class="radio-row" style="margin-top:8px;">
        <label><input type="checkbox" id="cd-ppi" /> <span>Proton Pump Inhibitor</span></label>
        <label><input type="checkbox" id="cd-mgo" /> <span>Magnesium oxide ‚â•800 mg/day</span></label>
        <label><input type="checkbox" id="cd-abx" /> <span>Antibiotics (current or recent)</span></label>
      </div>
      <div class="radio-row" style="margin-top:8px;">
        <label><input type="checkbox" id="cd-ibd" /> <span>IBS / Crohn's / Ulcerative Colitis</span></label>
        <label><input type="checkbox" id="cd-tube" /> <span>Tube feedings (recent change?)</span></label>
      </div>
    </fieldset>

    <div class="divider"></div>
    <h3>Prior C. diff testing</h3>
    <fieldset class="fs">
      <legend>Recent results</legend>
      <div class="radio-row">
        <label><input type="checkbox" id="cd-pos-30d" /> <span>Positive C. diff (GDH/Toxin/PCR) in last 30 days</span></label>
        <label><input type="checkbox" id="cd-neg-7d" /> <span>Negative C. diff in last 7 days</span></label>
      </div>
      <div class="help">If positive within 30 days and symptomatic, provider may treat without re-testing. Avoid re-testing within 7 days unless symptoms worsen.</div>
    </fieldset>

    <div class="divider"></div>
    <div id="cd-print-area">
      <h3>Team attestation</h3>
      <div class="row">
        <div>
          <label for="cd-nurse">Primary Nurse Name</label>
          <input type="text" id="cd-nurse" placeholder="Name" />
        </div>
        <div>
          <label for="cd-charge">Charge Nurse Signature</label>
          <input type="text" id="cd-charge" placeholder="Signature" />
        </div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button class="btn" id="cd-run">Evaluate Ticket</button>
        <button class="btn btn-secondary" id="cd-print" type="button">Print / Save PDF</button>
      </div>
      <div id="cd-result" role="status" aria-live="polite"></div>
      <details style="margin-top:12px;">
        <summary>Notes</summary>
        <ul><li>This tool supports GMH/NHSN-aligned policy workflows and does not replace clinical judgment or hospital policy.</li></ul>
      </details>
    </div>
  </section>

  <!-- ============================================================
       SSI RISK
  ============================================================ -->
  <section class="panel" id="panel-ssi">
    <h2>SSI Risk (NHSN)</h2>
    <div class="help">NHSN-aligned decision support for evaluating potential Surgical Site Infections.</div>

    <!-- Mode toggle for SSI -->
    <div class="mode-toggle-bar">
      <button class="mode-btn active" id="ssi-mode-quick" onclick="setMode('ssi','quick')">‚ö° Quick Check</button>
      <button class="mode-btn" id="ssi-mode-full" onclick="setMode('ssi','full')">üî¨ Full Criteria</button>
    </div>

    <div id="ssi-quick-mode">
      <div class="help" style="margin-bottom:10px;">Answer 3 questions for a rapid SSI screen.</div>
      <fieldset class="fs">
        <legend>Event date within NHSN surveillance window (30 or 90 days post-op)?</legend>
        <div class="radio-row">
          <label><input type="radio" name="ssiq-window" value="Yes" /> <span>Yes</span></label>
          <label><input type="radio" name="ssiq-window" value="No" checked /> <span>No / Unknown</span></label>
        </div>
      </fieldset>
      <fieldset class="fs">
        <legend>Any of: purulent drainage, positive culture, or physician diagnosis of SSI?</legend>
        <div class="radio-row">
          <label><input type="radio" name="ssiq-criteria" value="Yes" /> <span>Yes</span></label>
          <label><input type="radio" name="ssiq-criteria" value="No" checked /> <span>No</span></label>
        </div>
      </fieldset>
      <fieldset class="fs">
        <legend>Infection present at time of surgery (PATOS)?</legend>
        <div class="radio-row">
          <label><input type="radio" name="ssiq-patos" value="Yes" /> <span>Yes ‚Äî infection documented intra-op</span></label>
          <label><input type="radio" name="ssiq-patos" value="No" checked /> <span>No</span></label>
        </div>
      </fieldset>
      <button class="btn" id="ssiq-run">Quick Check</button>
      <div id="ssiq-result"></div>
    </div>

    <div id="ssi-full-mode" style="display:none;">
      <div class="note" style="margin-top:10px;">
        For patient-specific surgical risk estimates, open the official <b>ACS NSQIP Surgical Risk Calculator</b>:
        <div style="margin-top:8px;">
          <a class="btn" href="https://riskcalculator.facs.org/" target="_blank" rel="noopener">Open ACS NSQIP Calculator ‚Üó</a>
        </div>
      </div>

      <details id="ssi-patos-box" class="note" style="border-left-color:#B32572; margin-top:16px;">
        <summary>PATOS ‚Äî Infection Present at Time of Surgery (NHSN)</summary>
        <div class="help" style="margin-top:10px;">
          <p><strong>Definition:</strong> Surgeon explicitly documents infection visualized during the NHSN operative procedure ‚Äî pus, abscess, infected tissue, or gross contamination. Suspicion or positive cultures alone do not meet PATOS.</p>
          <p style="margin-top:8px;"><strong>PATOS SSIs remain reportable</strong> but may be excluded from certain SIR calculations.</p>
        </div>
      </details>

      <fieldset class="fs" style="margin-top:16px;">
        <legend>PATOS</legend>
        <div class="radio-row">
          <label><input type="radio" name="ssi-patos" value="Yes" /> <span>Yes ‚Äî infection documented intra-operatively</span></label>
          <label><input type="radio" name="ssi-patos" value="No" checked /> <span>No</span></label>
        </div>
      </fieldset>

      <fieldset class="fs">
        <legend>Procedure &amp; Dates</legend>
        <div class="row">
          <div>
            <label for="ssi-proc">NHSN procedure category</label>
            <select id="ssi-proc"></select>
            <div id="ssi-proc-help" class="help"></div>
            <label for="ssi-proc-specific" style="margin-top:10px;">Specific procedure (optional)</label>
            <select id="ssi-proc-specific" disabled></select>
          </div>
          <div>
            <label for="ssi-procdate">Date of procedure</label>
            <input type="date" id="ssi-procdate" />
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <div>
            <label for="ssi-eventdate">Date of first qualifying element (DOE)</label>
            <input type="date" id="ssi-eventdate" />
            <div id="ssi-window-hint" class="help">(surveillance window will be calculated)</div>
          </div>
          <div>
            <label>Deepest tissue level</label>
            <div class="radio-row" id="ssi-depth" style="flex-direction:column; gap:6px;">
              <label><input type="radio" name="ssi-depth" value="superficial" /> <span>Superficial incisional</span></label>
              <label><input type="radio" name="ssi-depth" value="deep" /> <span>Deep incisional</span></label>
              <label><input type="radio" name="ssi-depth" value="orgspace" /> <span>Organ/Space</span></label>
            </div>
          </div>
        </div>
        <div id="ssi-window-banner" class="banner warn" style="display:none;" role="alert" aria-live="assertive">
          ‚ö†Ô∏è Event date appears outside the NHSN surveillance window for this procedure.
        </div>
      </fieldset>

      <!-- Superficial criteria -->
      <div id="ssi-crit-superficial" style="display:none;">
        <h3>Superficial Incisional ‚Äî Criteria</h3>
        <fieldset class="fs">
          <legend>Any ONE element required:</legend>
          <div class="radio-row"><label><input type="checkbox" id="si-pus" /> <span>Purulent drainage from superficial incision</span></label></div>
          <div class="radio-row" style="margin-top:6px;"><label><input type="checkbox" id="si-cx" /> <span>Organism from aseptically obtained incisional/subcutaneous specimen</span></label></div>
          <div class="radio-row" style="margin-top:6px;"><label><input type="checkbox" id="si-open" /> <span>Superficial incision deliberately opened/re-accessed AND ‚â•1 local sign (pain, swelling, erythema, heat)</span></label></div>
          <div class="radio-row" style="margin-top:6px;"><label><input type="checkbox" id="si-dx" /> <span>Physician/PA/NP diagnosis of superficial incisional SSI</span></label></div>
        </fieldset>
      </div>

      <!-- Deep criteria -->
      <div id="ssi-crit-deep" style="display:none;">
        <h3>Deep Incisional ‚Äî Criteria</h3>
        <fieldset class="fs">
          <legend>Any ONE element required:</legend>
          <div class="radio-row"><label><input type="checkbox" id="di-pus" /> <span>Purulent drainage from deep incision</span></label></div>
          <div class="radio-row" style="margin-top:6px;"><label><input type="checkbox" id="di-open" /> <span>Deep incision deliberately opened/re-accessed AND (organism identified OR fever/localized pain/tenderness)</span></label></div>
          <div class="radio-row" style="margin-top:6px;"><label><input type="checkbox" id="di-abscess" /> <span>Abscess or other evidence of deep incision infection on exam/histopathology/imaging</span></label></div>
        </fieldset>
      </div>

      <!-- Organ/Space criteria -->
      <div id="ssi-crit-orgspace" style="display:none;">
        <h3>Organ/Space ‚Äî Criteria</h3>
        <fieldset class="fs">
          <legend>Any ONE element required:</legend>
          <div class="radio-row"><label><input type="checkbox" id="os-pus" /> <span>Purulent drainage from a drain in the organ/space</span></label></div>
          <div class="radio-row" style="margin-top:6px;"><label><input type="checkbox" id="os-cx" /> <span>Organism from organ/space fluid or tissue</span></label></div>
          <div class="radio-row" style="margin-top:6px;"><label><input type="checkbox" id="os-abscess" /> <span>Abscess or other evidence of organ/space infection</span></label></div>
        </fieldset>
        <fieldset class="fs" style="margin-top:10px;">
          <legend>Site-specific requirement</legend>
          <label for="os-site">Select site (Chapter 17)</label>
          <select id="os-site"></select>
          <div class="radio-row" style="margin-top:8px;"><label><input type="checkbox" id="os-site-met" /> <span>Team confirms site-specific criterion is met (per Chapter 17)</span></label></div>
        </fieldset>
      </div>

      <button class="btn" id="ssi-run" style="margin-top:16px;">Calculate SSI</button>
      <div id="ssi-result" role="status" aria-live="polite"></div>
    </div>
  </section>

  <!-- ============================================================
       FEEDBACK
  ============================================================ -->
  <section class="panel" id="panel-feedback">
    <h2>Give Feedback</h2>
    <div class="help">Help us improve the HAI Tool. Please avoid including any patient identifiers or PHI.</div>
    <div style="margin-top:10px;">
      <iframe id="feedbackFormFrame" class="feedback-frame"
        src="https://forms.office.com/Pages/ResponsePage.aspx?id=n4yZReRvOEqPEfiKcxx-LZIvkyloy41EveLnqCxNkw1UQzRUSFhZQTYwUzIyOFZOOTU5MU9YMEVWNi4u&embed=true"
        title="HAI Tool Feedback Form" loading="lazy" allowfullscreen></iframe>
    </div>
    <div style="margin-top:12px;">
      <a class="btn" href="https://forms.office.com/Pages/ResponsePage.aspx?id=n4yZReRvOEqPEfiKcxx-LZIvkyloy41EveLnqCxNkw1UQzRUSFhZQTYwUzIyOFZOOTU5MU9YMEVWNi4u" target="_blank" rel="noopener">Open Feedback Form ‚Üó</a>
    </div>
    <div style="margin-top:14px;">
      <img src="feedback-qr.png" alt="QR code to open the HAI Tool Feedback form" class="feedback-qr" />
      <div class="help">Scan with your phone's camera to open the same form.</div>
    </div>
  </section>

  <footer class="caption">
    This tool supports NHSN-aligned reconciliation and policy workflows and does not replace clinical judgment or hospital policy.
  </footer>
</div>

<!-- ============================================================
     PWA SERVICE WORKER REGISTRATION
============================================================ -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    // Inline service worker via blob URL for single-file PWA
    const swCode = `
      const CACHE = 'hai-v1';
      const ASSETS = [self.location.pathname];
      self.addEventListener('install', e => e.waitUntil(caches.open(CACHE).then(c => c.addAll(ASSETS))));
      self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request).catch(() => caches.match(e.request)))));
    `;
    const blob = new Blob([swCode], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl).catch(() => {});
  });
}
</script>

<script>
/* ========= Utilities ========= */
const BLOOD_LEADERSHIP_LABEL = "Unit Leadership";
const URINE_LEADERSHIP_LABEL = "Unit Leadership";

function el(id){ return document.getElementById(id); }
function fmtDate(d){
  if(!d) return "";
  return new Intl.DateTimeFormat(undefined, {month:'short', day:'2-digit', year:'numeric'}).format(d);
}
function parseDateInput(id){
  const v = el(id)?.value;
  if(!v) return null;
  const d = new Date(v + "T00:00:00");
  return isNaN(d.getTime()) ? null : d;
}
function daysInclusive(start, end){
  if(!start || !end) return 0;
  const s = new Date(start.getFullYear(), start.getMonth(), start.getDate());
  const e = new Date(end.getFullYear(), end.getMonth(), end.getDate());
  if(s > e) return 0;
  return Math.floor((e - s)/86400000) + 1;
}
function addDays(d, n){
  const t = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  t.setDate(t.getDate()+n);
  return t;
}
function iwpText(anchor){
  if(!anchor) return "(set DOE or culture date)";
  const start = addDays(anchor, -3), end = addDays(anchor, 3);
  return `IWP: ${fmtDate(start)} ‚Äì ${fmtDate(end)}`;
}
function fToC(f){ return (f - 32) * 5/9; }

/* ---- Result card builder ---- */
function buildResultCard(status, headline, rationale, nextSteps, kvData) {
  // status: 'meets' | 'atrisk' | 'clear'
  const icons = { meets:'üî¥', atrisk:'üü°', clear:'üü¢' };
  const labels = { meets:'Meets Criteria', atrisk:'At Risk / Needs Monitoring', clear:'Does Not Meet Criteria' };
  let html = `<div class="result-card rc-${status}">`;
  html += `<div class="rc-header"><span class="rc-icon">${icons[status]}</span>${headline || labels[status]}</div>`;
  if(rationale) html += `<div class="rc-body">${rationale}</div>`;
  if(nextSteps) html += `<div class="rc-next"><strong>Next Steps:</strong>${nextSteps}</div>`;
  if(kvData && kvData.length){
    html += `<div class="rc-meta"><div class="kv-grid">`;
    kvData.forEach(([k,v]) => { html += `<div class="kv"><span class="k">${k}:</span> ${v}</div>`; });
    html += `</div></div>`;
  }
  // Copy button
  const copyText = `${labels[status]}\n${rationale ? rationale.replace(/<[^>]+>/g,'') : ''}\n${nextSteps ? nextSteps.replace(/<[^>]+>/g,'') : ''}`.trim();
  html += `<div class="rc-copy"><button class="btn btn-secondary" style="margin-top:0;padding:6px 12px;font-size:13px;" onclick="copyResult(this,'${btoa(unescape(encodeURIComponent(copyText)))}')">üìã Copy Result</button></div>`;
  html += `</div>`;
  return html;
}

function copyResult(btn, b64) {
  try {
    const text = decodeURIComponent(escape(atob(b64)));
    navigator.clipboard.writeText(text).then(() => {
      btn.textContent = '‚úì Copied!';
      setTimeout(() => btn.textContent = 'üìã Copy Result', 2000);
    });
  } catch(e) { btn.textContent = 'Copy failed'; }
}

/* ---- RIT helper ---- */
function checkRIT(priorDateId, assessId, bannerSuffix) {
  const prior = parseDateInput(priorDateId);
  const assess = parseDateInput(assessId);
  const banner = el('cl-rit-banner') || el('cl2-rit-banner') || el('cu-rit-banner') || el('vae-rit-banner');
  // We'll handle banner per-panel below
  if (!prior || !assess) return false;
  const days = daysInclusive(prior, assess);
  return days <= 14;
}

/* ========= TABS ========= */
document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    el('panel-' + t.getAttribute('data-tab')).classList.add('active');
  });
});

/* ========= MODE TOGGLE ========= */
function setMode(panel, mode) {
  const quickEl = el(panel + '-quick-mode');
  const fullEl = el(panel + '-full-mode');
  const qBtn = el(panel + '-mode-quick');
  const fBtn = el(panel + '-mode-full');
  if (quickEl) quickEl.style.display = mode === 'quick' ? 'block' : 'none';
  if (fullEl) fullEl.style.display = mode === 'full' ? 'block' : 'none';
  if (qBtn) qBtn.classList.toggle('active', mode === 'quick');
  if (fBtn) fBtn.classList.toggle('active', mode === 'full');
}

/* ========= QUICK CHECK RUNNERS ========= */
el('clq-run').addEventListener('click', () => {
  const eligible = document.querySelector('input[name="clq-eligible"]:checked')?.value === 'Yes';
  const bcx = document.querySelector('input[name="clq-bcx"]:checked')?.value === 'Yes';
  const secondary = document.querySelector('input[name="clq-secondary"]:checked')?.value === 'Yes';
  let status, rationale, next;
  if (secondary) {
    status = 'clear';
    rationale = 'BSI appears secondary to another infection site ‚Äî not reportable as CLABSI. Document the primary source.';
    next = 'Investigate and document the secondary source. Consult IP if uncertain.';
  } else if (eligible && bcx) {
    status = 'meets';
    rationale = 'Patient potentially meets NHSN CLABSI criteria. Switch to Full Criteria mode for complete validation and organism-specific rules.';
    next = 'Switch to Full Criteria mode and complete full CLABSI surveillance evaluation. Notify Infection Prevention.';
  } else if (bcx && !eligible) {
    status = 'atrisk';
    rationale = 'Positive blood culture present but central line not yet eligible (&gt;2 days required). Monitor for developing CLABSI if line dwell time increases.';
    next = 'Continue monitoring. Reassess eligibility as catheter days accumulate.';
  } else {
    status = 'clear';
    rationale = 'Does not currently meet CLABSI screening criteria.';
    next = 'Continue standard surveillance. Re-evaluate if clinical status changes.';
  }
  el('clq-result').innerHTML = buildResultCard(status, null, rationale, next, []);
});

el('cauq-run').addEventListener('click', () => {
  const eligible = document.querySelector('input[name="cauq-eligible"]:checked')?.value === 'Yes';
  const ucx = document.querySelector('input[name="cauq-ucx"]:checked')?.value === 'Yes';
  const sx = document.querySelector('input[name="cauq-sx"]:checked')?.value === 'Yes';
  let status, rationale, next;
  if (eligible && ucx && sx) {
    status = 'meets';
    rationale = 'Patient potentially meets NHSN SUTI (Symptomatic UTI) CAUTI criteria.';
    next = 'Switch to Full Criteria mode for complete CAUTI surveillance evaluation. Notify Infection Prevention.';
  } else if ((ucx || sx) && eligible) {
    status = 'atrisk';
    rationale = 'Partial criteria met. Positive culture or symptoms present with eligible catheter.';
    next = 'Switch to Full Criteria mode and complete full evaluation.';
  } else {
    status = 'clear';
    rationale = 'Does not currently meet CAUTI screening criteria.';
    next = 'Continue standard surveillance. Re-evaluate if clinical status changes.';
  }
  el('cauq-result').innerHTML = buildResultCard(status, null, rationale, next, []);
});

el('ssiq-run').addEventListener('click', () => {
  const window_ = document.querySelector('input[name="ssiq-window"]:checked')?.value === 'Yes';
  const criteria = document.querySelector('input[name="ssiq-criteria"]:checked')?.value === 'Yes';
  const patos = document.querySelector('input[name="ssiq-patos"]:checked')?.value === 'Yes';
  let status, rationale, next;
  if (window_ && criteria && patos) {
    status = 'meets';
    rationale = 'Meets SSI criteria. Note: PATOS is indicated ‚Äî this event is still reportable but should be flagged as PATOS in NHSN (may affect SIR).';
    next = 'Report in NHSN and flag PATOS. Consult IP for documentation review.';
  } else if (window_ && criteria) {
    status = 'meets';
    rationale = 'Potentially meets NHSN SSI criteria within surveillance window.';
    next = 'Switch to Full Criteria mode for complete SSI validation. Notify Infection Prevention.';
  } else if (!window_) {
    status = 'clear';
    rationale = 'Event date is outside the NHSN surveillance window ‚Äî not reportable as SSI.';
    next = 'Document clinically but do not report to NHSN. Consult IP if uncertain about timing.';
  } else {
    status = 'atrisk';
    rationale = 'Within surveillance window but qualifying criteria not yet confirmed.';
    next = 'Continue monitoring. Switch to Full Criteria for detailed evaluation.';
  }
  el('ssiq-result').innerHTML = buildResultCard(status, null, rationale, next, []);
});

/* ========= RIT WIRE-UPS ========= */
function wireRIT(name, dateWrapId, bannerEl, assessId) {
  document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
    r.addEventListener('change', () => {
      const yes = document.querySelector(`input[name="${name}"]:checked`)?.value === 'Yes';
      el(dateWrapId).style.display = yes ? 'block' : 'none';
    });
  });
  const ritDateInput = el(dateWrapId)?.querySelector('input[type=date]');
  if (ritDateInput) {
    ritDateInput.addEventListener('change', () => {
      const prior = new Date(ritDateInput.value + 'T00:00:00');
      const assess = parseDateInput(assessId);
      if (!prior || !assess || isNaN(prior)) { bannerEl.style.display = 'none'; return; }
      const days = daysInclusive(prior, assess);
      bannerEl.style.display = days <= 14 ? 'block' : 'none';
    });
  }
}
wireRIT('cl-rit', 'cl-rit-date-wrap', el('cl-rit-banner'), 'cl-assess');
wireRIT('cl2-rit', 'cl2-rit-date-wrap', el('cl2-rit-banner'), 'cl2-assess');
wireRIT('cu-rit', 'cu-rit-date-wrap', el('cu-rit-banner'), 'cu-assess');
wireRIT('vae-rit', 'vae-rit-date-wrap', el('vae-rit-banner'), 'vae-assess');

/* ========= CLABSI FULL ========= */
document.querySelectorAll('#cl-inplace-row input[type=radio]').forEach(r => {
  r.addEventListener('change', () => {
    const val = document.querySelector('input[name="cl-inplace"]:checked')?.value;
    el('cl-removal-wrap').style.display = (val === 'No') ? 'block' : 'none';
    updateClabsiEligibilityBanner();
  });
});
el('cl-use-bcx').addEventListener('change', e => {
  el('cl-bcx-wrap').style.display = e.target.checked ? 'block' : 'none';
  updateCL_IWPLabel();
});
['cl-assess','cl-bcx'].forEach(id => el(id)?.addEventListener('change', updateCL_IWPLabel));
el('cl-tempf').addEventListener('input', () => {
  const f = parseFloat(el('cl-tempf').value||0);
  el('cl-tempc').textContent = `‚âà ${fToC(f).toFixed(1)} ¬∞C`;
});

function updateClabsiEligibilityBanner(){
  const banner = el('cl-eligibility-banner');
  if(!banner) return;
  const inplace = document.querySelector('input[name="cl-inplace"]:checked')?.value === 'Yes';
  if(inplace){ banner.style.display='none'; return; }
  const ins = parseDateInput('cl-insert');
  const removal = parseDateInput('cl-removal');
  if(!ins || !removal || ins > removal){ banner.style.display='none'; return; }
  banner.style.display = daysInclusive(ins, removal) <= 2 ? 'block' : 'none';
}
['cl-insert','cl-removal'].forEach(id => el(id)?.addEventListener('change', updateClabsiEligibilityBanner));

function updateCL_IWPLabel(){
  const anchor = el('cl-use-bcx').checked ? parseDateInput('cl-bcx') : parseDateInput('cl-assess');
  el('cl-iwp-hint').textContent = iwpText(anchor);
}

el('cl-run').addEventListener('click', () => {
  const ins = parseDateInput('cl-insert');
  const asmt = parseDateInput('cl-assess');
  const inplace = document.querySelector('input[name="cl-inplace"]:checked')?.value || 'No';
  let removal = inplace === 'No' ? parseDateInput('cl-removal') : null;
  const useBcx = el('cl-use-bcx').checked;
  const bcx = useBcx ? parseDateInput('cl-bcx') : null;

  const errors = [];
  if(!ins || !asmt) errors.push("Please enter insertion and assessment dates.");
  if(ins && asmt && ins > asmt) errors.push("Insertion date cannot be after the assessment date.");
  if(errors.length){ el('cl-result').innerHTML = buildResultCard('atrisk', 'Input Error', errors.join('<br>'), null, []); return; }

  let inPlaceFlag = (inplace === 'Yes');
  if(!inPlaceFlag && removal && asmt && removal.getTime() === asmt.getTime()) inPlaceFlag = true;

  const effectiveEnd = inPlaceFlag ? asmt : (removal || asmt);
  const clDays = daysInclusive(ins, effectiveEnd);
  const eligible = clDays > 2;

  let devAssoc = inPlaceFlag;
  if(!devAssoc && removal && asmt) devAssoc = removal.getTime() === addDays(asmt,-1).getTime();

  const anchor = bcx || asmt;
  el('cl-iwp-hint').textContent = iwpText(anchor);

  const fever = fToC(parseFloat(el('cl-tempf').value||0)) > 38.0;
  const hypo = document.querySelector('input[name="cl-hypo"]:checked')?.value === 'Yes';
  const chills = document.querySelector('input[name="cl-chills"]:checked')?.value === 'Yes';
  const bcxPos = document.querySelector('input[name="cl-bcxpos"]:checked')?.value === 'Yes';
  const symptomAny = fever || hypo || chills;
  const meets = bcxPos && eligible && devAssoc;

  // RIT check
  const ritYes = document.querySelector('input[name="cl-rit"]:checked')?.value === 'Yes';
  const priorDate = parseDateInput('cl-rit-date');
  const withinRIT = ritYes && priorDate && asmt && daysInclusive(priorDate, asmt) <= 14;

  const transfer = document.querySelector('input[name="cl-transfer"]:checked')?.value;

  const kv = [
    ['Central line days', clDays],
    ['Eligible (>2 days)', eligible ? 'Yes' : 'No'],
    ['Device-associated', devAssoc ? 'Yes' : 'No'],
    ['Positive blood culture', bcxPos ? 'Yes' : 'No'],
    ['Symptoms within IWP', symptomAny ? 'Yes ('+[fever&&'Fever',hypo&&'Hypotension',chills&&'Chills'].filter(Boolean).join(', ')+')' : 'No'],
    ['IWP', iwpText(anchor)],
  ];
  if (transfer) kv.push(['Unit attribution', transfer === 'Yes' ? 'This unit' : 'Transferred ‚Äî notify originating unit IP']);

  let status, rationale, next;
  const reasons = [];
  if(!bcxPos) reasons.push('No positive blood culture.');
  if(!eligible) reasons.push('Not eligible: central line ‚â§2 calendar days at time of assessment.');
  if(!devAssoc) reasons.push('Not device-associated: line not in place on DOE or removed day before.');

  if(withinRIT) {
    status = 'atrisk';
    rationale = '‚ö†Ô∏è Within 14-day RIT window ‚Äî this event may not be separately reportable as a new CLABSI event.';
    next = 'Review the prior event. Consult your IP team before reporting as a new event.';
  } else if(meets) {
    status = 'meets';
    rationale = 'Patient <strong>meets NHSN CLABSI criteria</strong> as of the assessment date.';
    next = 'Notify Infection Prevention immediately. Document in NHSN. Begin root cause investigation. Review CLABSI bundle compliance.';
  } else if(symptomAny) {
    status = 'atrisk';
    rationale = 'Symptoms within IWP but full CLABSI criteria not yet met. ' + (reasons.length ? 'Missing: ' + reasons.join(' ') : '');
    next = 'Continue close monitoring. Obtain blood cultures if not already done. Reassess device necessity daily.';
  } else {
    status = 'clear';
    rationale = 'Does not meet NHSN CLABSI criteria as of assessment date.' + (reasons.length ? ' Reason(s): ' + reasons.join(' ') : '');
    next = 'Continue standard central line care bundle. Reassess device necessity daily.';
  }
  el('cl-result').innerHTML = buildResultCard(status, null, rationale, next, kv);
});

/* ========= CLABSI 2: Organism Lists ========= */
const CL2_PATHOGENS = ["Staphylococcus aureus","Enterococcus faecalis","Enterococcus faecium","Streptococcus pneumoniae","Escherichia coli","Klebsiella pneumoniae","Klebsiella oxytoca","Enterobacter cloacae complex","Serratia marcescens","Proteus mirabilis","Pseudomonas aeruginosa","Acinetobacter baumannii","Stenotrophomonas maltophilia","Bacteroides fragilis","Clostridium perfringens","Fusobacterium nucleatum","Candida albicans","Candida glabrata","Candida parapsilosis","Candida tropicalis","Candida krusei"];
const CL2_SKIN_FLORA = new Set(["Staphylococcus epidermidis","Staphylococcus hominis","Staphylococcus capitis","Staphylococcus saprophyticus","Corynebacterium striatum","Corynebacterium jeikeium","Corynebacterium amycolatum","Cutibacterium acnes","Bacillus cereus","Bacillus subtilis","Bacillus licheniformis","Micrococcus luteus","Aerococcus urinae"]);
const CL2_MBI_ORGANISMS = new Set(["Candida albicans","Candida glabrata","Candida parapsilosis","Candida tropicalis","Candida krusei","Bacteroides fragilis","Fusobacterium nucleatum","Enterococcus faecalis","Enterococcus faecium"]);

function initCL2OrganismDropdown(){
  const sel = el('cl2-organism');
  if(!sel) return;
  const allOrgs = [...Array.from(CL2_SKIN_FLORA), ...CL2_PATHOGENS];
  sel.innerHTML = '<option value="">Select organism‚Ä¶</option>' + allOrgs.map(o => `<option value="${o}">${o}</option>`).join('');
}

function updateCL2OrganismUI(){
  const org = el('cl2-organism')?.value || '';
  const isSkin = CL2_SKIN_FLORA.has(org);
  const isMBI = CL2_MBI_ORGANISMS.has(org);
  const bcxPos = document.querySelector('input[name="cl2-bcxpos"]:checked')?.value === 'Yes';
  el('cl2-sx-wrap').style.display = isSkin ? 'block' : 'none';
  el('cl2-comm-wrap').style.display = (isSkin && bcxPos) ? 'block' : 'none';
  el('cl2-mbi-wrap').style.display = (isMBI && bcxPos) ? 'block' : 'none';
}

document.querySelectorAll('#cl2-inplace-row input[type=radio]').forEach(r => {
  r.addEventListener('change', () => {
    const val = document.querySelector('input[name="cl2-inplace"]:checked')?.value;
    el('cl2-removal-wrap').style.display = (val === 'No') ? 'block' : 'none';
    updateClabsi2EligibilityBanner();
  });
});
el('cl2-use-bcx')?.addEventListener('change', e => {
  el('cl2-bcx-wrap').style.display = e.target.checked ? 'block' : 'none';
  updateCL2_IWPLabel();
});
['cl2-assess','cl2-bcx'].forEach(id => el(id)?.addEventListener('change', updateCL2_IWPLabel));
el('cl2-tempf')?.addEventListener('input', () => {
  const f = parseFloat(el('cl2-tempf').value||0);
  el('cl2-tempc').textContent = `‚âà ${fToC(f).toFixed(1)} ¬∞C`;
});
el('cl2-organism')?.addEventListener('change', updateCL2OrganismUI);
document.querySelectorAll('input[name="cl2-bcxpos"]').forEach(r => r.addEventListener('change', updateCL2OrganismUI));

function updateClabsi2EligibilityBanner(){
  const banner = el('cl2-eligibility-banner');
  if(!banner) return;
  const inplace = document.querySelector('input[name="cl2-inplace"]:checked')?.value === 'Yes';
  if(inplace){ banner.style.display='none'; return; }
  const ins = parseDateInput('cl2-insert');
  const removal = parseDateInput('cl2-removal');
  if(!ins || !removal || ins > removal){ banner.style.display='none'; return; }
  banner.style.display = daysInclusive(ins, removal) <= 2 ? 'block' : 'none';
}
['cl2-insert','cl2-removal'].forEach(id => el(id)?.addEventListener('change', updateClabsi2EligibilityBanner));

function updateCL2_IWPLabel(){
  const anchor = el('cl2-use-bcx')?.checked ? parseDateInput('cl2-bcx') : parseDateInput('cl2-assess');
  if(el('cl2-iwp-hint')) el('cl2-iwp-hint').textContent = iwpText(anchor);
}

el('cl2-run')?.addEventListener('click', () => {
  const ins = parseDateInput('cl2-insert');
  const asmt = parseDateInput('cl2-assess');
  const inplace = document.querySelector('input[name="cl2-inplace"]:checked')?.value || 'No';
  let removal = inplace === 'No' ? parseDateInput('cl2-removal') : null;
  const useBcx = el('cl2-use-bcx')?.checked;
  const bcx = useBcx ? parseDateInput('cl2-bcx') : null;

  const errors = [];
  if(!ins || !asmt) errors.push("Please enter insertion and assessment dates.");
  if(ins && asmt && ins > asmt) errors.push("Insertion date cannot be after the assessment date.");
  if(errors.length){ el('cl2-result').innerHTML = buildResultCard('atrisk','Input Error',errors.join('<br>'),null,[]); return; }

  let inPlaceFlag = (inplace === 'Yes');
  if(!inPlaceFlag && removal && asmt && removal.getTime() === asmt.getTime()) inPlaceFlag = true;

  const effectiveEnd = inPlaceFlag ? asmt : (removal || asmt);
  const clDays = daysInclusive(ins, effectiveEnd);
  const eligible = clDays > 2;
  let devAssoc = inPlaceFlag;
  if(!devAssoc && removal && asmt) devAssoc = removal.getTime() === addDays(asmt,-1).getTime();

  const anchor = bcx || asmt;
  if(el('cl2-iwp-hint')) el('cl2-iwp-hint').textContent = iwpText(anchor);

  const org = el('cl2-organism')?.value || '';
  const isSkin = CL2_SKIN_FLORA.has(org);
  const isMBI = CL2_MBI_ORGANISMS.has(org);

  const fever = fToC(parseFloat(el('cl2-tempf')?.value||0)) > 38.0;
  const hypo = document.querySelector('input[name="cl2-hypo"]:checked')?.value === 'Yes';
  const chills = document.querySelector('input[name="cl2-chills"]:checked')?.value === 'Yes';
  const symptomAny = fever || hypo || chills;
  const bcxPos = document.querySelector('input[name="cl2-bcxpos"]:checked')?.value === 'Yes';
  const bcxCount = parseInt(el('cl2-bcxcount')?.value||'0',10);
  const sepYes = document.querySelector('input[name="cl2-sep"]:checked')?.value === 'Yes';
  const mbiHSCT = el('cl2-mbi-hsct')?.checked;
  const mbiNeutro = el('cl2-mbi-neutro')?.checked;
  const mbiConditionMet = mbiHSCT || mbiNeutro;

  let meets = false;
  let mbiFlag = false;
  if(isSkin){
    meets = eligible && devAssoc && bcxPos && bcxCount >= 2 && sepYes && symptomAny;
  } else {
    meets = bcxPos && eligible && devAssoc;
  }
  if(meets && isMBI && bcxPos && mbiConditionMet) mbiFlag = true;

  const ritYes = document.querySelector('input[name="cl2-rit"]:checked')?.value === 'Yes';
  const priorDate = parseDateInput('cl2-rit-date');
  const withinRIT = ritYes && priorDate && asmt && daysInclusive(priorDate, asmt) <= 14;
  const transfer = document.querySelector('input[name="cl2-transfer"]:checked')?.value;

  const kv = [
    ['Organism', org || 'Not selected', org ? (isSkin ? 'Common commensal (LCBI 2/3)' : 'Recognized pathogen (LCBI 1)') : ''],
    ['Central line days', clDays],
    ['Eligible (>2 days)', eligible ? 'Yes' : 'No'],
    ['Device-associated', devAssoc ? 'Yes' : 'No'],
    ['IWP', iwpText(anchor)],
  ];
  if(isSkin) kv.push(['Commensal: ‚â•2 cultures on separate occasions', (bcxCount >= 2 && sepYes) ? 'Yes' : 'No']);
  if(isSkin) kv.push(['Qualifying symptoms', symptomAny ? 'Yes' : 'No']);
  if(mbiFlag) kv.push(['MBI-LCBI condition', 'Met ‚Äî flag in NHSN']);
  if(transfer) kv.push(['Attribution', transfer === 'Yes' ? 'This unit' : 'Transferred ‚Äî notify originating unit IP']);

  let status, rationale, next;
  const reasons = [];
  if(!bcxPos) reasons.push('No positive blood culture.');
  if(!eligible) reasons.push('Not eligible (‚â§2 central-line days).');
  if(!devAssoc) reasons.push('Not device-associated.');
  if(isSkin && bcxPos && bcxCount < 2) reasons.push('Fewer than 2 positive cultures (commensals require ‚â•2).');
  if(isSkin && bcxPos && bcxCount >= 2 && !sepYes) reasons.push('Cultures not on separate occasions.');
  if(isSkin && !symptomAny) reasons.push('No qualifying symptoms for commensal organism.');

  if(withinRIT) {
    status = 'atrisk';
    rationale = '‚ö†Ô∏è Within 14-day RIT window ‚Äî may not be separately reportable.';
    next = 'Consult IP before reporting as a new CLABSI event.';
  } else if(meets && mbiFlag) {
    status = 'meets';
    rationale = 'Meets NHSN CLABSI criteria. <strong>MBI-LCBI conditions met</strong> ‚Äî report in NHSN and flag as MBI-LCBI. This event may be excluded from SIR calculations.';
    next = 'Report in NHSN with MBI-LCBI flag. Consult IP. Document MBI condition in the patient chart.';
  } else if(meets) {
    status = 'meets';
    rationale = 'Patient <strong>meets NHSN CLABSI criteria</strong> as of the assessment date.';
    next = 'Notify Infection Prevention. Document in NHSN. Begin root cause investigation.';
  } else if(symptomAny || bcxPos) {
    status = 'atrisk';
    rationale = 'Partial criteria. ' + (reasons.length ? 'Missing: ' + reasons.join(' ') : '');
    next = 'Continue monitoring. Complete additional cultures or reassess criteria as needed.';
  } else {
    status = 'clear';
    rationale = 'Does not meet NHSN CLABSI criteria. ' + (reasons.length ? 'Reason(s): ' + reasons.join(' ') : '');
    next = 'Continue central line bundle. Reassess device necessity daily.';
  }
  el('cl2-result').innerHTML = buildResultCard(status, null, rationale, next, kv);
});

initCL2OrganismDropdown();
updateCL2_IWPLabel();
updateCL2OrganismUI();

/* ========= CAUTI FULL ========= */
document.querySelectorAll('#cu-inplace-row input[type=radio]').forEach(r => {
  r.addEventListener('change', () => {
    const val = document.querySelector('input[name="cu-inplace"]:checked')?.value || 'No';
    el('cu-removal').disabled = (val === 'Yes');
    el('cu-catheter-in-place-note').style.display = (val === 'Yes') ? 'block' : 'none';
    updateCautiEligibilityBanner();
  });
});
el('cu-use-ucx').addEventListener('change', e => {
  el('cu-ucx-wrap').style.display = e.target.checked ? 'block' : 'none';
  updateCU_IWPLabel();
});
['cu-assess','cu-ucx','cu-insert','cu-removal','cu-prior-insert'].forEach(id => {
  el(id)?.addEventListener('change', () => { updateCU_IWPLabel(); updateCautiEligibilityBanner(); });
});

// Prior catheter toggle
el('cu-prior-enable')?.addEventListener('change', e => {
  el('cu-prior-wrap').style.display = e.target.checked ? 'block' : 'none';
  updateCautiEligibilityBanner();
});
el('cu-tempf').addEventListener('input', () => {
  const f = parseFloat(el('cu-tempf').value||0);
  el('cu-tempc').textContent = `‚âà ${fToC(f).toFixed(1)} ¬∞C`;
});

function updateCautiEligibilityBanner(){
  const banner = el('cu-eligibility-banner');
  if(!banner) return;
  const inplace = document.querySelector('input[name="cu-inplace"]:checked')?.value === 'Yes';
  if(inplace){ banner.style.display='none'; return; }
  const usePrior = el('cu-prior-enable')?.checked;
  const earliestIns = usePrior && parseDateInput('cu-prior-insert')
    ? parseDateInput('cu-prior-insert')
    : parseDateInput('cu-insert');
  const removal = parseDateInput('cu-removal');
  if(!earliestIns || !removal || earliestIns > removal){ banner.style.display='none'; return; }
  banner.style.display = daysInclusive(earliestIns, removal) <= 2 ? 'block' : 'none';
}
function updateCU_IWPLabel(){
  const anchor = el('cu-use-ucx').checked ? parseDateInput('cu-ucx') : parseDateInput('cu-assess');
  el('cu-iwp-hint').textContent = iwpText(anchor);
}

el('cu-run').addEventListener('click', () => {
  const ins = parseDateInput('cu-insert');
  const asmt = parseDateInput('cu-assess');
  const inplace = document.querySelector('input[name="cu-inplace"]:checked')?.value || 'No';
  let removal = inplace === 'Yes' ? null : parseDateInput('cu-removal');
  const useUcx = el('cu-use-ucx').checked;
  const ucx = useUcx ? parseDateInput('cu-ucx') : null;

  // Prior catheter: use earliest insertion date for eligibility day count
  const usePrior = el('cu-prior-enable')?.checked;
  const priorIns = usePrior ? parseDateInput('cu-prior-insert') : null;
  const earliestIns = (priorIns && ins && priorIns < ins) ? priorIns : ins;

  const errors = [];
  if(!ins || !asmt) errors.push("Please enter insertion and assessment dates.");
  if(ins && asmt && ins > asmt) errors.push("Insertion date cannot be after the assessment date.");
  if(priorIns && ins && priorIns >= ins) errors.push("Prior catheter insertion date must be before the current catheter insertion date.");
  if(inplace === 'No' && !removal) errors.push("Please enter removal date when catheter is not in place.");
  if(errors.length){ el('cu-result').innerHTML = buildResultCard('atrisk','Input Error',errors.join('<br>'),null,[]); return; }

  let inPlaceFlag = (inplace === 'Yes');
  if(!inPlaceFlag && removal && asmt && removal.getTime() === asmt.getTime()) inPlaceFlag = true;

  // Eligibility uses earliest insertion; device association uses current catheter
  const days = daysInclusive(earliestIns, inPlaceFlag ? asmt : removal);
  const eligible = days > 2;
  let devAssoc = inPlaceFlag;
  if(!devAssoc && removal && asmt) devAssoc = removal.getTime() === addDays(asmt,-1).getTime();

  const anchor = ucx || asmt;
  el('cu-iwp-hint').textContent = iwpText(anchor);

  const ucxPos = document.querySelector('input[name="cu-ucxpos"]:checked')?.value === 'Yes';

  const fever = fToC(parseFloat(el('cu-tempf').value||0)) > 38.0;
  const supra = document.querySelector('input[name="cu-supra"]:checked')?.value === 'Yes';
  const cva   = document.querySelector('input[name="cu-cva"]:checked')?.value === 'Yes';
  const urgency   = inPlaceFlag ? false : (document.querySelector('input[name="cu-urg"]:checked')?.value === 'Yes');
  const frequency = inPlaceFlag ? false : (document.querySelector('input[name="cu-freq"]:checked')?.value === 'Yes');
  const dysuria   = inPlaceFlag ? false : (document.querySelector('input[name="cu-dys"]:checked')?.value === 'Yes');
  const anySymptom = fever || supra || cva || urgency || frequency || dysuria;

  const meets = ucxPos && eligible && devAssoc && anySymptom;

  const ritYes = document.querySelector('input[name="cu-rit"]:checked')?.value === 'Yes';
  const priorDate = parseDateInput('cu-rit-date');
  const withinRIT = ritYes && priorDate && asmt && daysInclusive(priorDate, asmt) <= 14;
  const transfer = document.querySelector('input[name="cu-transfer"]:checked')?.value;

  const kv = [
    ['Catheter days (combined)', days + (priorIns ? ` (from prior insertion ${priorIns.toISOString().slice(0,10)})` : '')],
    ['Eligible (>2 days)', eligible ? 'Yes' : 'No'],
    ['Device-associated', devAssoc ? 'Yes' : 'No'],
    ['Positive urine culture', ucxPos ? 'Yes' : 'No'],
    ['Symptoms (SUTI)', anySymptom ? [fever&&'Fever',supra&&'Suprapubic',cva&&'CVA',urgency&&'Urgency',frequency&&'Frequency',dysuria&&'Dysuria'].filter(Boolean).join(', ') : 'None'],
    ['IWP', iwpText(anchor)],
  ];
  if(transfer) kv.push(['Attribution', transfer === 'Yes' ? 'This unit' : 'Transferred ‚Äî notify originating unit IP']);

  const reasons = [];
  if(!ucxPos) reasons.push('No positive urine culture.');
  if(!eligible) reasons.push('Not eligible: catheter ‚â§2 calendar days.');
  if(!devAssoc) reasons.push('Not device-associated.');
  if(!anySymptom) reasons.push('No qualifying symptoms.');

  let status, rationale, next;
  if(withinRIT) {
    status = 'atrisk';
    rationale = '‚ö†Ô∏è Within 14-day RIT window ‚Äî this event may not be separately reportable.';
    next = 'Review prior event. Consult IP before reporting as a new CAUTI event.';
  } else if(meets) {
    status = 'meets';
    rationale = 'Patient meets NHSN <strong>SUTI (Symptomatic UTI)</strong> CAUTI criteria as of the assessment date.';
    next = 'Notify Infection Prevention. Document in NHSN. Reassess catheter necessity. Begin bundle review.';
  } else if(anySymptom || ucxPos) {
    status = 'atrisk';
    rationale = 'Partial criteria. ' + (reasons.length ? 'Missing: ' + reasons.join(' ') : '');
    next = 'Continue monitoring. Reassess catheter necessity. Follow up on pending cultures.';
  } else {
    status = 'clear';
    rationale = 'Does not meet NHSN CAUTI criteria. ' + (reasons.length ? 'Reason(s): ' + reasons.join(' ') : '');
    next = 'Continue catheter care bundle. Reassess device necessity daily.';
  }
  el('cu-result').innerHTML = buildResultCard(status, null, rationale, next, kv);
});

/* ========= VAE ========= */
function updateVAEDays() {
  const start = parseDateInput('vae-vent-start');
  const assess = parseDateInput('vae-assess');
  const disp = el('vae-ventdays-display');
  if (!start || !assess) { disp.textContent = ''; return; }
  const days = daysInclusive(start, assess);
  disp.textContent = `Ventilator days at assessment: Day ${days} ${days > 2 ? '‚úì Eligible' : '‚Äî Not yet eligible (need >2 days)'}`;
}
['vae-vent-start','vae-assess'].forEach(id => el(id)?.addEventListener('change', updateVAEDays));

function updateVAETiers() {
  const baseline = document.querySelector('input[name="vac-baseline"]:checked')?.value === 'Yes';
  const worsen = document.querySelector('input[name="vac-worsen"]:checked')?.value;
  const vacMet = baseline && worsen && worsen !== 'No';

  const ivacTier = el('vae-tier-ivac');
  const pvapTier = el('vae-tier-pvap');

  if(vacMet) {
    ivacTier.classList.remove('locked');
    const tempwbc = document.querySelector('input[name="ivac-tempwbc"]:checked')?.value === 'Yes';
    const abx = document.querySelector('input[name="ivac-abx"]:checked')?.value === 'Yes';
    const ivacMet = tempwbc && abx;
    if(ivacMet) {
      pvapTier.classList.remove('locked');
    } else {
      pvapTier.classList.add('locked');
    }
  } else {
    ivacTier.classList.add('locked');
    pvapTier.classList.add('locked');
  }
}

document.querySelectorAll('input[name="vac-baseline"], input[name="vac-worsen"], input[name="ivac-tempwbc"], input[name="ivac-abx"]').forEach(r => {
  r.addEventListener('change', updateVAETiers);
});

el('vae-run')?.addEventListener('click', () => {
  const ventStart = parseDateInput('vae-vent-start');
  const assess = parseDateInput('vae-assess');

  const errors = [];
  if(!ventStart || !assess) errors.push('Please enter ventilator start date and assessment date.');
  if(ventStart && assess && ventStart > assess) errors.push('Ventilator start cannot be after assessment date.');
  if(errors.length){ el('vae-result').innerHTML = buildResultCard('atrisk','Input Error',errors.join('<br>'),null,[]); return; }

  const ventDays = daysInclusive(ventStart, assess);
  const eligible = ventDays > 2;

  const baseline = document.querySelector('input[name="vac-baseline"]:checked')?.value === 'Yes';
  const worsen = document.querySelector('input[name="vac-worsen"]:checked')?.value;
  const vacMet = eligible && baseline && worsen && worsen !== 'No';

  const tempwbc = document.querySelector('input[name="ivac-tempwbc"]:checked')?.value === 'Yes';
  const abx = document.querySelector('input[name="ivac-abx"]:checked')?.value === 'Yes';
  const ivacMet = vacMet && tempwbc && abx;

  const culture = el('pvap-culture')?.checked;
  const purulent = el('pvap-purulent')?.checked;
  const imaging = el('pvap-imaging')?.checked;
  const pvapMet = ivacMet && (culture || purulent || imaging);

  const ritYes = document.querySelector('input[name="vae-rit"]:checked')?.value === 'Yes';
  const priorDate = parseDateInput('vae-rit-date');
  const withinRIT = ritYes && priorDate && assess && daysInclusive(priorDate, assess) <= 14;

  const kv = [
    ['Ventilator days', ventDays],
    ['Eligible (>2 days)', eligible ? 'Yes' : 'No'],
    ['VAC met', vacMet ? `Yes (${worsen === 'fio2' ? 'FiO‚ÇÇ ‚â•0.20 increase' : 'PEEP ‚â•3 cmH‚ÇÇO increase'})` : 'No'],
    ['IVAC met', ivacMet ? 'Yes' : 'No'],
    ['PVAP met', pvapMet ? 'Yes' : 'No'],
  ];

  let status, rationale, next;
  if(withinRIT) {
    status = 'atrisk';
    rationale = '‚ö†Ô∏è Within 14-day RIT window ‚Äî this event may not be separately reportable.';
    next = 'Review prior event. Consult IP before reporting as a new VAE.';
  } else if(pvapMet) {
    status = 'meets';
    rationale = 'Patient meets NHSN <strong>PVAP (Possible VAP)</strong> criteria ‚Äî the highest tier of the VAE algorithm.';
    next = 'Notify Infection Prevention. Document in NHSN. Review ventilator bundle compliance. Consider diagnostic workup for pneumonia.';
  } else if(ivacMet) {
    status = 'meets';
    rationale = 'Patient meets NHSN <strong>IVAC (Infection-Related VAC)</strong> criteria. Does not yet meet PVAP ‚Äî no qualifying respiratory culture/secretion criteria.';
    next = 'Notify Infection Prevention. Obtain respiratory cultures if clinically indicated. Document in NHSN.';
  } else if(vacMet) {
    status = 'atrisk';
    rationale = 'Patient meets <strong>VAC (Ventilator-Associated Condition)</strong> criteria. Does not yet meet IVAC ‚Äî temperature/WBC abnormality or new antimicrobial not documented.';
    next = 'Monitor for IVAC criteria. Review antimicrobial therapy and vital signs. Consult IP.';
  } else if(!eligible) {
    status = 'clear';
    rationale = 'Patient not yet eligible for VAE surveillance (requires >2 ventilator days).';
    next = 'Continue ventilator bundle care. Re-evaluate daily.';
  } else {
    status = 'clear';
    rationale = 'Does not meet VAE criteria. No qualifying oxygenation worsening after a stable/improving baseline period.';
    next = 'Continue ventilator bundle care. Reassess daily.';
  }
  el('vae-result').innerHTML = buildResultCard(status, null, rationale, next, kv);
});

/* ========= Blood Culture Escalation ========= */
function updateBlood(){
  const hasCVC = document.querySelector('input[name="bc-hascvc"]:checked')?.value === 'Yes';
  el('bc-when-yes').style.display = hasCVC ? 'block' : 'none';
  el('bc-when-no').style.display  = hasCVC ? 'none' : 'block';
  if(hasCVC){
    const recent = document.querySelector('input[name="bc-recentadm"]:checked')?.value === 'Yes';
    el('bc-out-yes').style.display = 'block';
    el('bc-out-yes').innerHTML = recent
      ? `‚úÖ Acquire blood culture ‚Äî escalation to <b>${BLOOD_LEADERSHIP_LABEL}</b> not needed.`
      : `‚ö†Ô∏è Contact <b>${BLOOD_LEADERSHIP_LABEL}</b> to assist in clinical necessity.`;
  } else {
    const recentCVC = document.querySelector('input[name="bc-recentcvc"]:checked')?.value === 'Yes';
    el('bc-out-no').style.display = 'block';
    el('bc-out-no').innerHTML = recentCVC
      ? `‚ö†Ô∏è Contact <b>${BLOOD_LEADERSHIP_LABEL}</b> to assist in clinical necessity.`
      : `‚úÖ Acquire blood culture ‚Äî escalation to <b>${BLOOD_LEADERSHIP_LABEL}</b> not needed.`;
  }
}
document.querySelectorAll('input[name="bc-hascvc"], input[name="bc-recentadm"], input[name="bc-recentcvc"]').forEach(x => x.addEventListener('change', updateBlood));
updateBlood();

/* ========= Urine Culture Escalation ========= */
function updateUrine(){
  const hasFoley = document.querySelector('input[name="uc-hasfoley"]:checked')?.value === 'Yes';
  el('uc-when-yes').style.display = hasFoley ? 'block' : 'none';
  el('uc-when-no').style.display  = hasFoley ? 'none' : 'block';
  if(hasFoley){
    const recent = document.querySelector('input[name="uc-recentadm"]:checked')?.value === 'Yes';
    el('uc-out-yes').style.display = 'block';
    el('uc-out-yes').innerHTML = recent
      ? `‚úÖ Acquire urine culture ‚Äî escalation to <b>${URINE_LEADERSHIP_LABEL}</b> not needed.`
      : `‚ö†Ô∏è Contact <b>${URINE_LEADERSHIP_LABEL}</b> to assist with clinical necessity.`;
  } else {
    const recentFoley = document.querySelector('input[name="uc-recentfoley"]:checked')?.value === 'Yes';
    el('uc-out-no').style.display = 'block';
    el('uc-out-no').innerHTML = recentFoley
      ? `‚ö†Ô∏è Contact <b>${URINE_LEADERSHIP_LABEL}</b> to assist with clinical necessity.`
      : `‚úÖ Acquire urine culture ‚Äî escalation to <b>${URINE_LEADERSHIP_LABEL}</b> not needed.`;
  }
}
document.querySelectorAll('input[name="uc-hasfoley"], input[name="uc-recentadm"], input[name="uc-recentfoley"]').forEach(x => x.addEventListener('change', updateUrine));
updateUrine();

/* ========= SSI ========= */
const SSI_PROCEDURES = [
  {code:'AAA',name:'Abdominal aortic aneurysm repair',period:30},{code:'AMP',name:'Limb amputation',period:30},{code:'APPY',name:'Appendix surgery',period:30},{code:'AVSD',name:'Shunt for dialysis',period:30},{code:'BILI',name:'Bile duct, liver or pancreatic surgery',period:30},{code:'CEA',name:'Carotid endarterectomy',period:30},{code:'CHOL',name:'Gallbladder surgery',period:30},{code:'COLO',name:'Colon surgery',period:30},{code:'CSEC',name:'Cesarean section',period:30},{code:'GAST',name:'Gastric surgery',period:30},{code:'HTP',name:'Heart transplant',period:30},{code:'HYST',name:'Abdominal hysterectomy',period:30},{code:'KTP',name:'Kidney transplant',period:30},{code:'LAM',name:'Laminectomy',period:30},{code:'LTP',name:'Liver transplant',period:30},{code:'NECK',name:'Neck surgery',period:30},{code:'NEPH',name:'Kidney surgery',period:30},{code:'OVRY',name:'Ovarian surgery',period:30},{code:'PRST',name:'Prostate surgery',period:30},{code:'REC',name:'Rectal surgery',period:30},{code:'SB',name:'Small bowel surgery',period:30},{code:'SPLE',name:'Spleen surgery',period:30},{code:'THOR',name:'Thoracic surgery',period:30},{code:'THYR',name:'Thyroid/parathyroid surgery',period:30},{code:'VHYS',name:'Vaginal hysterectomy',period:30},{code:'XLAP',name:'Exploratory laparotomy',period:30},
  {code:'BRST',name:'Breast surgery',period:90},{code:'CARD',name:'Cardiac surgery',period:90},{code:'CBGB',name:'CABG ‚Äî chest + donor incisions',period:90},{code:'CBGC',name:'CABG ‚Äî chest incision only',period:90},{code:'CRAN',name:'Craniotomy',period:90},{code:'FUSN',name:'Spinal fusion',period:90},{code:'FX',name:'Open reduction of fracture',period:90},{code:'HER',name:'Herniorrhaphy',period:90},{code:'HPRO',name:'Hip prosthesis',period:90},{code:'KPRO',name:'Knee prosthesis',period:90},{code:'PACE',name:'Pacemaker surgery',period:90},{code:'PVBY',name:'Peripheral vascular bypass',period:90},{code:'VSHN',name:'Ventricular shunt',period:90},
];
const SSI_OS_SITES = ['BONE','BRST','CARD','DISC','EAR','EMET','ENDO','GIT','IAB','IC','JNT','LUNG','MED','MEN','ORAL','OREP','PJI','SA','SINU','UR','USI','VASC','VCUF'];
const SSI_SPECIFIC_BY_YEAR = {"2026":{"COLO":[{label:"Right hemicolectomy (open/lap)"},{label:"Sigmoid colectomy (open/lap)"},{label:"Transverse colectomy"},{label:"Subtotal colectomy"}],"HPRO":[{label:"Total hip arthroplasty (primary)"},{label:"Revision total hip arthroplasty"},{label:"Hemiarthroplasty of hip"}],"HYST":[{label:"Abdominal hysterectomy"},{label:"Robotic-assisted total hysterectomy"}]}};

(function initSSIUI(){
  const procSel = el('ssi-proc');
  if(procSel) procSel.innerHTML = '<option value="">Select procedure‚Ä¶</option>' + SSI_PROCEDURES.map(p => `<option value="${p.code}">${p.code} ‚Äî ${p.name}</option>`).join('');
  const siteSel = el('os-site');
  if(siteSel) siteSel.innerHTML = '<option value="">Select site‚Ä¶</option>' + SSI_OS_SITES.map(s => `<option value="${s}">${s}</option>`).join('');
})();

function updateSSIDepthUI(){
  const depth = document.querySelector('input[name="ssi-depth"]:checked')?.value || '';
  el('ssi-crit-superficial').style.display = depth==='superficial' ? 'block':'none';
  el('ssi-crit-deep').style.display        = depth==='deep' ? 'block':'none';
  el('ssi-crit-orgspace').style.display    = depth==='orgspace' ? 'block':'none';
}
document.querySelectorAll('input[name="ssi-depth"]').forEach(r => r.addEventListener('change', updateSSIDepthUI));

function updateSSIWindowHints(){
  const proc = el('ssi-proc')?.value || '';
  const procDate = parseDateInput('ssi-procdate');
  const evDate = parseDateInput('ssi-eventdate');
  const hint = el('ssi-window-hint');
  const banner = el('ssi-window-banner');
  banner.style.display = 'none';
  if(!proc || !procDate){ hint.textContent = '(surveillance window will be calculated)'; return; }
  const meta = SSI_PROCEDURES.find(p => p.code===proc);
  const days = meta?.period || 30;
  const end30 = addDays(procDate, 29);
  const end90 = addDays(procDate, 89);
  hint.textContent = `Superficial: up to ${fmtDate(end30)}; Deep/Organ-Space: up to ${fmtDate(days===90?end90:end30)}`;
  if(evDate){ const beyondDeepOS = (days===30 && evDate > end30) || (days===90 && evDate > end90); if(beyondDeepOS) banner.style.display='block'; }
}
['ssi-proc','ssi-procdate','ssi-eventdate'].forEach(id => el(id)?.addEventListener('change', updateSSIWindowHints));
updateSSIWindowHints();

const specificSel = el('ssi-proc-specific');
function populateSpecificProcedures(){
  const cat = el('ssi-proc')?.value || '';
  const procDate = parseDateInput('ssi-procdate');
  const y = procDate ? String(procDate.getFullYear()) : "2026";
  const map = SSI_SPECIFIC_BY_YEAR[y] || SSI_SPECIFIC_BY_YEAR["2026"];
  const entries = (map && cat) ? (map[cat]||[]) : [];
  if(!cat){ specificSel.innerHTML='<option value="">Select category first‚Ä¶</option>'; specificSel.disabled=true; return; }
  if(!entries.length){ specificSel.innerHTML='<option value="">(No specific procedures for this category)</option>'; specificSel.disabled=true; return; }
  specificSel.disabled=false;
  specificSel.innerHTML='<option value="">Select specific procedure‚Ä¶</option>'+entries.map(e=>`<option value="${e.label}">${e.label}</option>`).join('');
}
['ssi-proc','ssi-procdate'].forEach(id => el(id)?.addEventListener('change', populateSpecificProcedures));
populateSpecificProcedures();

el('ssi-run')?.addEventListener('click', () => {
  const procCode = el('ssi-proc')?.value || '';
  const procDate = parseDateInput('ssi-procdate');
  const evDate = parseDateInput('ssi-eventdate');
  const depth = document.querySelector('input[name="ssi-depth"]:checked')?.value || '';
  const patos = document.querySelector('input[name="ssi-patos"]:checked')?.value === 'Yes';

  const errors = [];
  if(!procCode) errors.push('Select an NHSN procedure category.');
  if(!procDate) errors.push('Enter the procedure date.');
  if(!evDate) errors.push('Enter the Date of first qualifying element (DOE).');
  if(!depth) errors.push('Choose the deepest tissue level involved.');
  if(errors.length){ el('ssi-result').innerHTML = buildResultCard('atrisk','Input Error',errors.join('<br>'),null,[]); return; }

  const meta = SSI_PROCEDURES.find(p => p.code===procCode);
  const deepOSPeriod = meta?.period||30;
  const end30 = addDays(procDate, 29);
  const end90 = addDays(procDate, 89);
  let withinWindow = false;
  if(depth==='superficial') withinWindow = evDate >= procDate && evDate <= end30;
  else { const end = deepOSPeriod===90 ? end90 : end30; withinWindow = evDate >= procDate && evDate <= end; }

  let meets = false, partial = false;
  const reasons = [];
  if(!withinWindow) reasons.push('Event date outside NHSN surveillance window.');

  if(depth==='superficial'){
    const elAny = el('si-pus').checked||el('si-cx').checked||el('si-open').checked||el('si-dx').checked;
    meets = withinWindow && elAny;
    partial = !meets && (elAny || withinWindow);
    if(!elAny) reasons.push('No superficial incisional criterion selected.');
  } else if(depth==='deep'){
    const elAny = el('di-pus').checked||el('di-open').checked||el('di-abscess').checked;
    meets = withinWindow && elAny;
    partial = !meets && (elAny || withinWindow);
    if(!elAny) reasons.push('No deep incisional criterion selected.');
  } else if(depth==='orgspace'){
    const elAny = el('os-pus').checked||el('os-cx').checked||el('os-abscess').checked;
    const siteOK = el('os-site-met').checked && !!el('os-site')?.value;
    meets = withinWindow && elAny && siteOK;
    partial = !meets && ((elAny && !siteOK) || withinWindow);
    if(!elAny) reasons.push('No organ/space element selected.');
    if(!siteOK) reasons.push('Organ/space requires a confirmed site-specific criterion.');
  }

  const kv = [
    ['Procedure', `${procCode} ‚Äî ${meta?.name||''}`],
    ['Procedure date', procDate.toISOString().slice(0,10)],
    ['DOE', evDate.toISOString().slice(0,10)],
    ['Depth', depth],
    ['Surveillance window', el('ssi-window-hint').textContent],
    ['PATOS', patos ? 'Yes ‚Äî flag in NHSN' : 'No'],
  ];

  let status, rationale, next;
  if(meets && patos) {
    status = 'meets';
    rationale = 'Meets NHSN SSI criteria. <strong>PATOS flagged</strong> ‚Äî report in NHSN and mark as PATOS. This may affect SIR calculations.';
    next = 'Report in NHSN with PATOS flag. Consult IP for documentation review.';
  } else if(meets) {
    status = 'meets';
    rationale = 'Patient <strong>meets NHSN SSI criteria</strong> as of the DOE.';
    next = 'Notify Infection Prevention. Document in NHSN. Begin root cause analysis.';
  } else if(partial) {
    status = 'atrisk';
    rationale = 'Partially meets criteria. ' + (reasons.length ? 'Missing: ' + reasons.join(' ') : '');
    next = 'Continue monitoring and documentation. Consult IP for guidance.';
  } else {
    status = 'clear';
    rationale = 'Does not meet NHSN SSI criteria.' + (reasons.length ? ' Reason(s): ' + reasons.join(' ') : '');
    next = 'Continue standard wound surveillance. Re-evaluate if clinical signs change.';
  }
  el('ssi-result').innerHTML = buildResultCard(status, null, rationale, next, kv);
});

/* ========= C. diff Ticket ========= */
function updateCdiffDayHints(){
  const admit = parseDateInput('cd-admit');
  const collect = parseDateInput('cd-collect');
  const hint = el('cd-hospday-hint');
  const banner = el('cd-day4-banner');
  banner.style.display = 'none';
  if(!admit || !collect){ hint.textContent='(hospitalization day will be calculated)'; return; }
  if(admit > collect){ hint.textContent='‚ö†Ô∏è Admission cannot be after the collection date.'; return; }
  const hospDay = daysInclusive(admit, collect);
  hint.textContent = `Hospitalization day at time of collection: Day ${hospDay}`;
  if(hospDay >= 4) banner.style.display = 'block';
}

function runCdiffTicket(){
  const admit = parseDateInput('cd-admit');
  const collect = parseDateInput('cd-collect');
  const errors = [];
  if(!admit || !collect) errors.push('Please enter Admission and Collection dates.');
  if(admit && collect && admit > collect) errors.push('Admission date cannot be after the collection date.');

  const hospDay = (admit && collect) ? daysInclusive(admit, collect) : null;
  const newDiarrhea = document.querySelector('input[name="cd-newdiarrhea"]:checked')?.value === 'Yes';
  const stoolCount = parseInt(el('cd-stoolcount').value||'0',10);
  const bristol = parseInt(document.querySelector('input[name="cd-bristol"]:checked')?.value||'0',10);
  const sxWBC=el('cd-sx-wbc').checked, sxPain=el('cd-sx-pain').checked, sxFever=el('cd-sx-fever').checked;
  const hasLax24=el('cd-lax-24h').checked, hasPrep48=el('cd-prep-48h').checked, hasIBD=el('cd-ibd').checked;
  const hasPPI=el('cd-ppi').checked, hasMgO=el('cd-mgo').checked, onAbx=el('cd-abx').checked, tubeFeed=el('cd-tube').checked;
  const pos30d=el('cd-pos-30d').checked, neg7d=el('cd-neg-7d').checked;

  if(errors.length){ el('cd-result').innerHTML = buildResultCard('atrisk','Input Error',errors.join('<br>'),null,[]); return; }

  const has3orMore = stoolCount >= 3;
  const bristolOk = bristol >= 6;
  const supportive = sxWBC||sxPain||sxFever;

  const hardStops = [];
  if(pos30d){
    if(newDiarrhea||supportive) hardStops.push('Positive C. diff within 30 days and symptomatic ‚Äî discuss treating without re-testing.');
    else hardStops.push('Positive C. diff within 30 days and no symptoms ‚Äî avoid re-testing and avoid treating.');
  }
  if(neg7d) hardStops.push('Negative C. diff within 7 days ‚Äî avoid re-testing unless symptoms have worsened.');
  if(hasLax24) hardStops.push('Laxatives/stool softeners within 24 h ‚Äî consider holding testing.');
  if(hasPrep48) hardStops.push('Bowel prep/enema within 48 h ‚Äî consider holding testing.');

  const caution = [];
  if(tubeFeed) caution.push('Tube feeds (recent change?)');
  if(hasPPI) caution.push('PPI');
  if(hasMgO) caution.push('Magnesium oxide ‚â•800 mg/day');
  if(onAbx) caution.push('Current/recent antibiotics');
  if(hasIBD) caution.push('IBS/Crohn\'s/UC');

  const meetsDiarrhea = newDiarrhea && has3orMore && bristolOk;
  const hasHardStops = hardStops.length > 0;

  const kv = [
    ['Hospitalization day', hospDay !== null ? `Day ${hospDay}` : '‚Äî'],
    ['New onset diarrhea', newDiarrhea ? 'Yes' : 'No'],
    ['Unformed stools (24h)', stoolCount],
    ['Bristol type', bristol || '‚Äî'],
    ['Supportive symptoms', supportive ? 'Yes ('+[sxWBC&&'‚ÜëWBC',sxPain&&'Abd pain',sxFever&&'Fever'].filter(Boolean).join(', ')+')' : 'No'],
  ];

  let status, rationale, next;
  if(meetsDiarrhea && !hasHardStops){
    status = 'meets';
    rationale = 'Meets C. diff "Ticket to Test" criteria ‚Äî proceed to collect stool sample.';
    next = 'Collect stool per hospital protocol. Ensure specimen is unformed and conforms to container. Notify charge nurse.';
  } else {
    const reasons = [];
    if(!newDiarrhea) reasons.push('Not clearly new-onset diarrhea.');
    if(!has3orMore) reasons.push(`Fewer than 3 unformed stools in 24 h (${stoolCount} documented).`);
    if(!bristolOk) reasons.push(`Bristol type ${bristol||'not selected'} ‚Äî need type 6 or 7.`);
    reasons.push(...hardStops);
    status = 'atrisk';
    rationale = 'Defer & discuss with ordering provider before collecting. Reason(s): ' + reasons.join(' ');
    next = 'Discuss with ordering provider. Address modifiable factors (laxatives, bowel prep) before ordering.';
  }
  if(hospDay !== null && hospDay >= 4) rationale += ' <strong>‚ö†Ô∏è Hospital day ‚â•4 ‚Äî discuss with provider before collection.</strong>';
  if(caution.length) rationale += ` Considerations: ${caution.join('; ')}.`;

  const nurse = (el('cd-nurse').value||'').trim();
  const charge = (el('cd-charge').value||'').trim();
  if(nurse||charge) kv.push(['Attestation', [nurse&&`Nurse: ${nurse}`, charge&&`Charge: ${charge}`].filter(Boolean).join(' | ')]);

  el('cd-result').innerHTML = buildResultCard(status, null, rationale, next, kv);
}

['cd-admit','cd-collect'].forEach(id => el(id)?.addEventListener('change', updateCdiffDayHints));
el('cd-run')?.addEventListener('click', () => { updateCdiffDayHints(); runCdiffTicket(); });
el('cd-print')?.addEventListener('click', () => { updateCdiffDayHints(); runCdiffTicket(); setTimeout(() => window.print(), 50); });
updateCdiffDayHints();

/* ========= Init banners on load ========= */
updateClabsiEligibilityBanner();
updateClabsi2EligibilityBanner();
updateCautiEligibilityBanner();
updateVAEDays();
updateVAETiers();
</script>
</body>
</html>
